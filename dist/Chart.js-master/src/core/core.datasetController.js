'use strict';

module.exports = function (Chart) {

	var helpers = Chart.helpers;

	var arrayEvents = ['push', 'pop', 'shift', 'splice', 'unshift'];

	/**
  * Hooks the array methods that add or remove values ('push', pop', 'shift', 'splice',
  * 'unshift') and notify the listener AFTER the array has been altered. Listeners are
  * called on the 'onData*' callbacks (e.g. onDataPush, etc.) with same arguments.
  */
	function listenArrayEvents(array, listener) {
		if (array._chartjs) {
			array._chartjs.listeners.push(listener);
			return;
		}

		Object.defineProperty(array, '_chartjs', {
			configurable: true,
			enumerable: false,
			value: {
				listeners: [listener]
			}
		});

		arrayEvents.forEach(function (key) {
			var method = 'onData' + key.charAt(0).toUpperCase() + key.slice(1);
			var base = array[key];

			Object.defineProperty(array, key, {
				configurable: true,
				enumerable: false,
				value: function value() {
					var args = Array.prototype.slice.call(arguments);
					var res = base.apply(this, args);

					helpers.each(array._chartjs.listeners, function (object) {
						if (typeof object[method] === 'function') {
							object[method].apply(object, args);
						}
					});

					return res;
				}
			});
		});
	}

	/**
  * Removes the given array event listener and cleanup extra attached properties (such as
  * the _chartjs stub and overridden methods) if array doesn't have any more listeners.
  */
	function unlistenArrayEvents(array, listener) {
		var stub = array._chartjs;
		if (!stub) {
			return;
		}

		var listeners = stub.listeners;
		var index = listeners.indexOf(listener);
		if (index !== -1) {
			listeners.splice(index, 1);
		}

		if (listeners.length > 0) {
			return;
		}

		arrayEvents.forEach(function (key) {
			delete array[key];
		});

		delete array._chartjs;
	}

	// Base class for all dataset controllers (line, bar, etc)
	Chart.DatasetController = function (chart, datasetIndex) {
		this.initialize(chart, datasetIndex);
	};

	helpers.extend(Chart.DatasetController.prototype, {

		/**
   * Element type used to generate a meta dataset (e.g. Chart.element.Line).
   * @type {Chart.core.element}
   */
		datasetElementType: null,

		/**
   * Element type used to generate a meta data (e.g. Chart.element.Point).
   * @type {Chart.core.element}
   */
		dataElementType: null,

		initialize: function initialize(chart, datasetIndex) {
			var me = this;
			me.chart = chart;
			me.index = datasetIndex;
			me.linkScales();
			me.addElements();
		},

		updateIndex: function updateIndex(datasetIndex) {
			this.index = datasetIndex;
		},

		linkScales: function linkScales() {
			var me = this;
			var meta = me.getMeta();
			var dataset = me.getDataset();

			if (meta.xAxisID === null) {
				meta.xAxisID = dataset.xAxisID || me.chart.options.scales.xAxes[0].id;
			}
			if (meta.yAxisID === null) {
				meta.yAxisID = dataset.yAxisID || me.chart.options.scales.yAxes[0].id;
			}
		},

		getDataset: function getDataset() {
			return this.chart.data.datasets[this.index];
		},

		getMeta: function getMeta() {
			return this.chart.getDatasetMeta(this.index);
		},

		getScaleForId: function getScaleForId(scaleID) {
			return this.chart.scales[scaleID];
		},

		reset: function reset() {
			this.update(true);
		},

		/**
   * @private
   */
		destroy: function destroy() {
			if (this._data) {
				unlistenArrayEvents(this._data, this);
			}
		},

		createMetaDataset: function createMetaDataset() {
			var me = this;
			var type = me.datasetElementType;
			return type && new type({
				_chart: me.chart.chart,
				_datasetIndex: me.index
			});
		},

		createMetaData: function createMetaData(index) {
			var me = this;
			var type = me.dataElementType;
			return type && new type({
				_chart: me.chart.chart,
				_datasetIndex: me.index,
				_index: index
			});
		},

		addElements: function addElements() {
			var me = this;
			var meta = me.getMeta();
			var data = me.getDataset().data || [];
			var metaData = meta.data;
			var i, ilen;

			for (i = 0, ilen = data.length; i < ilen; ++i) {
				metaData[i] = metaData[i] || me.createMetaData(i);
			}

			meta.dataset = meta.dataset || me.createMetaDataset();
		},

		addElementAndReset: function addElementAndReset(index) {
			var element = this.createMetaData(index);
			this.getMeta().data.splice(index, 0, element);
			this.updateElement(element, index, true);
		},

		buildOrUpdateElements: function buildOrUpdateElements() {
			var me = this;
			var dataset = me.getDataset();
			var data = dataset.data || (dataset.data = []);

			// In order to correctly handle data addition/deletion animation (an thus simulate
			// real-time charts), we need to monitor these data modifications and synchronize
			// the internal meta data accordingly.
			if (me._data !== data) {
				if (me._data) {
					// This case happens when the user replaced the data array instance.
					unlistenArrayEvents(me._data, me);
				}

				listenArrayEvents(data, me);
				me._data = data;
			}

			// Re-sync meta data in case the user replaced the data array or if we missed
			// any updates and so make sure that we handle number of datapoints changing.
			me.resyncElements();
		},

		update: helpers.noop,

		draw: function draw(ease) {
			var easingDecimal = ease || 1;
			var i, len;
			var metaData = this.getMeta().data;
			for (i = 0, len = metaData.length; i < len; ++i) {
				metaData[i].transition(easingDecimal).draw();
			}
		},

		removeHoverStyle: function removeHoverStyle(element, elementOpts) {
			var dataset = this.chart.data.datasets[element._datasetIndex],
			    index = element._index,
			    custom = element.custom || {},
			    valueOrDefault = helpers.getValueAtIndexOrDefault,
			    model = element._model;

			model.backgroundColor = custom.backgroundColor ? custom.backgroundColor : valueOrDefault(dataset.backgroundColor, index, elementOpts.backgroundColor);
			model.borderColor = custom.borderColor ? custom.borderColor : valueOrDefault(dataset.borderColor, index, elementOpts.borderColor);
			model.borderWidth = custom.borderWidth ? custom.borderWidth : valueOrDefault(dataset.borderWidth, index, elementOpts.borderWidth);
		},

		setHoverStyle: function setHoverStyle(element) {
			var dataset = this.chart.data.datasets[element._datasetIndex],
			    index = element._index,
			    custom = element.custom || {},
			    valueOrDefault = helpers.getValueAtIndexOrDefault,
			    getHoverColor = helpers.getHoverColor,
			    model = element._model;

			model.backgroundColor = custom.hoverBackgroundColor ? custom.hoverBackgroundColor : valueOrDefault(dataset.hoverBackgroundColor, index, getHoverColor(model.backgroundColor));
			model.borderColor = custom.hoverBorderColor ? custom.hoverBorderColor : valueOrDefault(dataset.hoverBorderColor, index, getHoverColor(model.borderColor));
			model.borderWidth = custom.hoverBorderWidth ? custom.hoverBorderWidth : valueOrDefault(dataset.hoverBorderWidth, index, model.borderWidth);
		},

		/**
   * @private
   */
		resyncElements: function resyncElements() {
			var me = this;
			var meta = me.getMeta();
			var data = me.getDataset().data;
			var numMeta = meta.data.length;
			var numData = data.length;

			if (numData < numMeta) {
				meta.data.splice(numData, numMeta - numData);
			} else if (numData > numMeta) {
				me.insertElements(numMeta, numData - numMeta);
			}
		},

		/**
   * @private
   */
		insertElements: function insertElements(start, count) {
			for (var i = 0; i < count; ++i) {
				this.addElementAndReset(start + i);
			}
		},

		/**
   * @private
   */
		onDataPush: function onDataPush() {
			this.insertElements(this.getDataset().data.length - 1, arguments.length);
		},

		/**
   * @private
   */
		onDataPop: function onDataPop() {
			this.getMeta().data.pop();
		},

		/**
   * @private
   */
		onDataShift: function onDataShift() {
			this.getMeta().data.shift();
		},

		/**
   * @private
   */
		onDataSplice: function onDataSplice(start, count) {
			this.getMeta().data.splice(start, count);
			this.insertElements(start, arguments.length - 2);
		},

		/**
   * @private
   */
		onDataUnshift: function onDataUnshift() {
			this.insertElements(0, arguments.length);
		}
	});

	Chart.DatasetController.extend = helpers.inherits;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUuZGF0YXNldENvbnRyb2xsZXIuanMiXSwibmFtZXMiOlsibW9kdWxlIiwiZXhwb3J0cyIsIkNoYXJ0IiwiaGVscGVycyIsImFycmF5RXZlbnRzIiwibGlzdGVuQXJyYXlFdmVudHMiLCJhcnJheSIsImxpc3RlbmVyIiwiX2NoYXJ0anMiLCJsaXN0ZW5lcnMiLCJwdXNoIiwiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJjb25maWd1cmFibGUiLCJlbnVtZXJhYmxlIiwidmFsdWUiLCJmb3JFYWNoIiwia2V5IiwibWV0aG9kIiwiY2hhckF0IiwidG9VcHBlckNhc2UiLCJzbGljZSIsImJhc2UiLCJhcmdzIiwiQXJyYXkiLCJwcm90b3R5cGUiLCJjYWxsIiwiYXJndW1lbnRzIiwicmVzIiwiYXBwbHkiLCJlYWNoIiwib2JqZWN0IiwidW5saXN0ZW5BcnJheUV2ZW50cyIsInN0dWIiLCJpbmRleCIsImluZGV4T2YiLCJzcGxpY2UiLCJsZW5ndGgiLCJEYXRhc2V0Q29udHJvbGxlciIsImNoYXJ0IiwiZGF0YXNldEluZGV4IiwiaW5pdGlhbGl6ZSIsImV4dGVuZCIsImRhdGFzZXRFbGVtZW50VHlwZSIsImRhdGFFbGVtZW50VHlwZSIsIm1lIiwibGlua1NjYWxlcyIsImFkZEVsZW1lbnRzIiwidXBkYXRlSW5kZXgiLCJtZXRhIiwiZ2V0TWV0YSIsImRhdGFzZXQiLCJnZXREYXRhc2V0IiwieEF4aXNJRCIsIm9wdGlvbnMiLCJzY2FsZXMiLCJ4QXhlcyIsImlkIiwieUF4aXNJRCIsInlBeGVzIiwiZGF0YSIsImRhdGFzZXRzIiwiZ2V0RGF0YXNldE1ldGEiLCJnZXRTY2FsZUZvcklkIiwic2NhbGVJRCIsInJlc2V0IiwidXBkYXRlIiwiZGVzdHJveSIsIl9kYXRhIiwiY3JlYXRlTWV0YURhdGFzZXQiLCJ0eXBlIiwiX2NoYXJ0IiwiX2RhdGFzZXRJbmRleCIsImNyZWF0ZU1ldGFEYXRhIiwiX2luZGV4IiwibWV0YURhdGEiLCJpIiwiaWxlbiIsImFkZEVsZW1lbnRBbmRSZXNldCIsImVsZW1lbnQiLCJ1cGRhdGVFbGVtZW50IiwiYnVpbGRPclVwZGF0ZUVsZW1lbnRzIiwicmVzeW5jRWxlbWVudHMiLCJub29wIiwiZHJhdyIsImVhc2UiLCJlYXNpbmdEZWNpbWFsIiwibGVuIiwidHJhbnNpdGlvbiIsInJlbW92ZUhvdmVyU3R5bGUiLCJlbGVtZW50T3B0cyIsImN1c3RvbSIsInZhbHVlT3JEZWZhdWx0IiwiZ2V0VmFsdWVBdEluZGV4T3JEZWZhdWx0IiwibW9kZWwiLCJfbW9kZWwiLCJiYWNrZ3JvdW5kQ29sb3IiLCJib3JkZXJDb2xvciIsImJvcmRlcldpZHRoIiwic2V0SG92ZXJTdHlsZSIsImdldEhvdmVyQ29sb3IiLCJob3ZlckJhY2tncm91bmRDb2xvciIsImhvdmVyQm9yZGVyQ29sb3IiLCJob3ZlckJvcmRlcldpZHRoIiwibnVtTWV0YSIsIm51bURhdGEiLCJpbnNlcnRFbGVtZW50cyIsInN0YXJ0IiwiY291bnQiLCJvbkRhdGFQdXNoIiwib25EYXRhUG9wIiwicG9wIiwib25EYXRhU2hpZnQiLCJzaGlmdCIsIm9uRGF0YVNwbGljZSIsIm9uRGF0YVVuc2hpZnQiLCJpbmhlcml0cyJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE9BQU9DLE9BQVAsR0FBaUIsVUFBU0MsS0FBVCxFQUFnQjs7QUFFaEMsS0FBSUMsVUFBVUQsTUFBTUMsT0FBcEI7O0FBRUEsS0FBSUMsY0FBYyxDQUFDLE1BQUQsRUFBUyxLQUFULEVBQWdCLE9BQWhCLEVBQXlCLFFBQXpCLEVBQW1DLFNBQW5DLENBQWxCOztBQUVBOzs7OztBQUtBLFVBQVNDLGlCQUFULENBQTJCQyxLQUEzQixFQUFrQ0MsUUFBbEMsRUFBNEM7QUFDM0MsTUFBSUQsTUFBTUUsUUFBVixFQUFvQjtBQUNuQkYsU0FBTUUsUUFBTixDQUFlQyxTQUFmLENBQXlCQyxJQUF6QixDQUE4QkgsUUFBOUI7QUFDQTtBQUNBOztBQUVESSxTQUFPQyxjQUFQLENBQXNCTixLQUF0QixFQUE2QixVQUE3QixFQUF5QztB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QVc7QUFDdEIsUUFBS0gsY0FBTCxDQUFvQixLQUFLdEQsVUFBTCxHQUFrQlEsSUFBbEIsQ0FBdUJ2QixNQUF2QixHQUE4QixDQUFsRCxFQUFxRFYsVUFBVVUsTUFBL0Q7QUFDQSxHQWpNZ0Q7O0FBbU1qRDs7O0FBR0F5RSxhQUFXLHFCQUFXO0FBQ3JCLFFBQUs1RCxPQUFMLEdBQWVVLElBQWYsQ0FBb0JtRCxHQUFwQjtBQUNBLEdBeE1nRDs7QUEwTWpEOzs7QUFHQUMsZUFBYSx1QkFBVztBQUN2QixRQUFLOUQsT0FBTCxHQUFlVSxJQUFmLENBQW9CcUQsS0FBcEI7QUFDQSxHQS9NZ0Q7O0FBaU5qRDs7O0FBR0FDLGdCQUFjLHNCQUFTUCxLQUFULEVBQWdCQyxLQUFoQixFQUF1QjtBQUNwQyxRQUFLMUQsT0FBTCxHQUFlVSxJQUFmLENBQW9CeEIsTUFBcEIsQ0FBMkJ1RSxLQUEzQixFQUFrQ0MsS0FBbEM7QUFDQSxRQUFLRixjQUFMLENBQW9CQyxLQUFwQixFQUEyQmhGLFVBQVVVLE1BQVYsR0FBbUIsQ0FBOUM7QUFDQSxHQXZOZ0Q7O0FBeU5qRDs7O0FBR0E4RSxpQkFBZSx5QkFBVztBQUN6QixRQUFLVCxjQUFMLENBQW9CLENBQXBCLEVBQXVCL0UsVUFBVVUsTUFBakM7QUFDQTtBQTlOZ0QsRUFBbEQ7O0FBaU9BbkMsT0FBTW9DLGlCQUFOLENBQXdCSSxNQUF4QixHQUFpQ3ZDLFFBQVFpSCxRQUF6QztBQUNBLENBbFREIiwiZmlsZSI6ImNvcmUuZGF0YXNldENvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7XHJcblxyXG5cdHZhciBoZWxwZXJzID0gQ2hhcnQuaGVscGVycztcclxuXHJcblx0dmFyIGFycmF5RXZlbnRzID0gWydwdXNoJywgJ3BvcCcsICdzaGlmdCcsICdzcGxpY2UnLCAndW5zaGlmdCddO1xyXG5cclxuXHQvKipcclxuXHQgKiBIb29rcyB0aGUgYXJyYXkgbWV0aG9kcyB0aGF0IGFkZCBvciByZW1vdmUgdmFsdWVzICgncHVzaCcsIHBvcCcsICdzaGlmdCcsICdzcGxpY2UnLFxyXG5cdCAqICd1bnNoaWZ0JykgYW5kIG5vdGlmeSB0aGUgbGlzdGVuZXIgQUZURVIgdGhlIGFycmF5IGhhcyBiZWVuIGFsdGVyZWQuIExpc3RlbmVycyBhcmVcclxuXHQgKiBjYWxsZWQgb24gdGhlICdvbkRhdGEqJyBjYWxsYmFja3MgKGUuZy4gb25EYXRhUHVzaCwgZXRjLikgd2l0aCBzYW1lIGFyZ3VtZW50cy5cclxuXHQgKi9cclxuXHRmdW5jdGlvbiBsaXN0ZW5BcnJheUV2ZW50cyhhcnJheSwgbGlzdGVuZXIpIHtcclxuXHRcdGlmIChhcnJheS5fY2hhcnRqcykge1xyXG5cdFx0XHRhcnJheS5fY2hhcnRqcy5saXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7XHJcblx0XHRcdHJldHVybjtcclxuXHRcdH1cclxuXHJcblx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoYXJyYXksICdfY2hhcnRqcycsIHtcclxuXHRcdFx0Y29uZmlndXJhYmxlOiB0cnVlLFxyXG5cdFx0XHRlbnVtZXJhYmxlOiBmYWxzZSxcclxuXHRcdFx0dmFsdWU6IHtcclxuXHRcdFx0XHRsaXN0ZW5lcnM6IFtsaXN0ZW5lcl1cclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblxyXG5cdFx0YXJyYXlFdmVudHMuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcclxuXHRcdFx0dmFyIG1ldGhvZCA9ICdvbkRhdGEnICsga2V5LmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsga2V5LnNsaWNlKDEpO1xyXG5cdFx0XHR2YXIgYmFzZSA9IGFycmF5W2tleV07XHJcblxyXG5cdFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkoYXJyYXksIGtleSwge1xyXG5cdFx0XHRcdGNvbmZpZ3VyYWJsZTogdHJ1ZSxcclxuXHRcdFx0XHRlbnVtZXJhYmxlOiBmYWxzZSxcclxuXHRcdFx0XHR2YWx1ZTogZnVuY3Rpb24oKSB7XHJcblx0XHRcdFx0XHR2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyk7XHJcblx0XHRcdFx0XHR2YXIgcmVzID0gYmFzZS5hcHBseSh0aGlzLCBhcmdzKTtcclxuXHJcblx0XHRcdFx0XHRoZWxwZXJzLmVhY2goYXJyYXkuX2NoYXJ0anMubGlzdGVuZXJzLCBmdW5jdGlvbihvYmplY3QpIHtcclxuXHRcdFx0XHRcdFx0aWYgKHR5cGVvZiBvYmplY3RbbWV0aG9kXSA9PT0gJ2Z1bmN0aW9uJykge1xyXG5cdFx0XHRcdFx0XHRcdG9iamVjdFttZXRob2RdLmFwcGx5KG9iamVjdCwgYXJncyk7XHJcblx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdH0pO1xyXG5cclxuXHRcdFx0XHRcdHJldHVybiByZXM7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9KTtcclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0LyoqXHJcblx0ICogUmVtb3ZlcyB0aGUgZ2l2ZW4gYXJyYXkgZXZlbnQgbGlzdGVuZXIgYW5kIGNsZWFudXAgZXh0cmEgYXR0YWNoZWQgcHJvcGVydGllcyAoc3VjaCBhc1xyXG5cdCAqIHRoZSBfY2hhcnRqcyBzdHViIGFuZCBvdmVycmlkZGVuIG1ldGhvZHMpIGlmIGFycmF5IGRvZXNuJ3QgaGF2ZSBhbnkgbW9yZSBsaXN0ZW5lcnMuXHJcblx0ICovXHJcblx0ZnVuY3Rpb24gdW5saXN0ZW5BcnJheUV2ZW50cyhhcnJheSwgbGlzdGVuZXIpIHtcclxuXHRcdHZhciBzdHViID0gYXJyYXkuX2NoYXJ0anM7XHJcblx0XHRpZiAoIXN0dWIpIHtcclxuXHRcdFx0cmV0dXJuO1xyXG5cdFx0fVxyXG5cclxuXHRcdHZhciBsaXN0ZW5lcnMgPSBzdHViLmxpc3RlbmVycztcclxuXHRcdHZhciBpbmRleCA9IGxpc3RlbmVycy5pbmRleE9mKGxpc3RlbmVyKTtcclxuXHRcdGlmIChpbmRleCAhPT0gLTEpIHtcclxuXHRcdFx0bGlzdGVuZXJzLnNwbGljZShpbmRleCwgMSk7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKGxpc3RlbmVycy5sZW5ndGggPiAwKSB7XHJcblx0XHRcdHJldHVybjtcclxuXHRcdH1cclxuXHJcblx0XHRhcnJheUV2ZW50cy5mb3JFYWNoKGZ1bmN0aW9uKGtleSkge1xyXG5cdFx0XHRkZWxldGUgYXJyYXlba2V5XTtcclxuXHRcdH0pO1xyXG5cclxuXHRcdGRlbGV0ZSBhcnJheS5fY2hhcnRqcztcclxuXHR9XHJcblxyXG5cdC8vIEJhc2UgY2xhc3MgZm9yIGFsbCBkYXRhc2V0IGNvbnRyb2xsZXJzIChsaW5lLCBiYXIsIGV0YylcclxuXHRDaGFydC5EYXRhc2V0Q29udHJvbGxlciA9IGZ1bmN0aW9uKGNoYXJ0LCBkYXRhc2V0SW5kZXgpIHtcclxuXHRcdHRoaXMuaW5pdGlhbGl6ZShjaGFydCwgZGF0YXNldEluZGV4KTtcclxuXHR9O1xyXG5cclxuXHRoZWxwZXJzLmV4dGVuZChDaGFydC5EYXRhc2V0Q29udHJvbGxlci5wcm90b3R5cGUsIHtcclxuXHJcblx0XHQvKipcclxuXHRcdCAqIEVsZW1lbnQgdHlwZSB1c2VkIHRvIGdlbmVyYXRlIGEgbWV0YSBkYXRhc2V0IChlLmcuIENoYXJ0LmVsZW1lbnQuTGluZSkuXHJcblx0XHQgKiBAdHlwZSB7Q2hhcnQuY29yZS5lbGVtZW50fVxyXG5cdFx0ICovXHJcblx0XHRkYXRhc2V0RWxlbWVudFR5cGU6IG51bGwsXHJcblxyXG5cdFx0LyoqXHJcblx0XHQgKiBFbGVtZW50IHR5cGUgdXNlZCB0byBnZW5lcmF0ZSBhIG1ldGEgZGF0YSAoZS5nLiBDaGFydC5lbGVtZW50LlBvaW50KS5cclxuXHRcdCAqIEB0eXBlIHtDaGFydC5jb3JlLmVsZW1lbnR9XHJcblx0XHQgKi9cclxuXHRcdGRhdGFFbGVtZW50VHlwZTogbnVsbCxcclxuXHJcblx0XHRpbml0aWFsaXplOiBmdW5jdGlvbihjaGFydCwgZGF0YXNldEluZGV4KSB7XHJcblx0XHRcdHZhciBtZSA9IHRoaXM7XHJcblx0XHRcdG1lLmNoYXJ0ID0gY2hhcnQ7XHJcblx0XHRcdG1lLmluZGV4ID0gZGF0YXNldEluZGV4O1xyXG5cdFx0XHRtZS5saW5rU2NhbGVzKCk7XHJcblx0XHRcdG1lLmFkZEVsZW1lbnRzKCk7XHJcblx0XHR9LFxyXG5cclxuXHRcdHVwZGF0ZUluZGV4OiBmdW5jdGlvbihkYXRhc2V0SW5kZXgpIHtcclxuXHRcdFx0dGhpcy5pbmRleCA9IGRhdGFzZXRJbmRleDtcclxuXHRcdH0sXHJcblxyXG5cdFx0bGlua1NjYWxlczogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHZhciBtZSA9IHRoaXM7XHJcblx0XHRcdHZhciBtZXRhID0gbWUuZ2V0TWV0YSgpO1xyXG5cdFx0XHR2YXIgZGF0YXNldCA9IG1lLmdldERhdGFzZXQoKTtcclxuXHJcblx0XHRcdGlmIChtZXRhLnhBeGlzSUQgPT09IG51bGwpIHtcclxuXHRcdFx0XHRtZXRhLnhBeGlzSUQgPSBkYXRhc2V0LnhBeGlzSUQgfHwgbWUuY2hhcnQub3B0aW9ucy5zY2FsZXMueEF4ZXNbMF0uaWQ7XHJcblx0XHRcdH1cclxuXHRcdFx0aWYgKG1ldGEueUF4aXNJRCA9PT0gbnVsbCkge1xyXG5cdFx0XHRcdG1ldGEueUF4aXNJRCA9IGRhdGFzZXQueUF4aXNJRCB8fCBtZS5jaGFydC5vcHRpb25zLnNjYWxlcy55QXhlc1swXS5pZDtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHJcblx0XHRnZXREYXRhc2V0OiBmdW5jdGlvbigpIHtcclxuXHRcdFx0cmV0dXJuIHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0c1t0aGlzLmluZGV4XTtcclxuXHRcdH0sXHJcblxyXG5cdFx0Z2V0TWV0YTogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHJldHVybiB0aGlzLmNoYXJ0LmdldERhdGFzZXRNZXRhKHRoaXMuaW5kZXgpO1xyXG5cdFx0fSxcclxuXHJcblx0XHRnZXRTY2FsZUZvcklkOiBmdW5jdGlvbihzY2FsZUlEKSB7XHJcblx0XHRcdHJldHVybiB0aGlzLmNoYXJ0LnNjYWxlc1tzY2FsZUlEXTtcclxuXHRcdH0sXHJcblxyXG5cdFx0cmVzZXQ6IGZ1bmN0aW9uKCkge1xyXG5cdFx0XHR0aGlzLnVwZGF0ZSh0cnVlKTtcclxuXHRcdH0sXHJcblxyXG5cdFx0LyoqXHJcblx0XHQgKiBAcHJpdmF0ZVxyXG5cdFx0ICovXHJcblx0XHRkZXN0cm95OiBmdW5jdGlvbigpIHtcclxuXHRcdFx0aWYgKHRoaXMuX2RhdGEpIHtcclxuXHRcdFx0XHR1bmxpc3RlbkFycmF5RXZlbnRzKHRoaXMuX2RhdGEsIHRoaXMpO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cclxuXHRcdGNyZWF0ZU1ldGFEYXRhc2V0OiBmdW5jdGlvbigpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIHR5cGUgPSBtZS5kYXRhc2V0RWxlbWVudFR5cGU7XHJcblx0XHRcdHJldHVybiB0eXBlICYmIG5ldyB0eXBlKHtcclxuXHRcdFx0XHRfY2hhcnQ6IG1lLmNoYXJ0LmNoYXJ0LFxyXG5cdFx0XHRcdF9kYXRhc2V0SW5kZXg6IG1lLmluZGV4XHJcblx0XHRcdH0pO1xyXG5cdFx0fSxcclxuXHJcblx0XHRjcmVhdGVNZXRhRGF0YTogZnVuY3Rpb24oaW5kZXgpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIHR5cGUgPSBtZS5kYXRhRWxlbWVudFR5cGU7XHJcblx0XHRcdHJldHVybiB0eXBlICYmIG5ldyB0eXBlKHtcclxuXHRcdFx0XHRfY2hhcnQ6IG1lLmNoYXJ0LmNoYXJ0LFxyXG5cdFx0XHRcdF9kYXRhc2V0SW5kZXg6IG1lLmluZGV4LFxyXG5cdFx0XHRcdF9pbmRleDogaW5kZXhcclxuXHRcdFx0fSk7XHJcblx0XHR9LFxyXG5cclxuXHRcdGFkZEVsZW1lbnRzOiBmdW5jdGlvbigpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIG1ldGEgPSBtZS5nZXRNZXRhKCk7XHJcblx0XHRcdHZhciBkYXRhID0gbWUuZ2V0RGF0YXNldCgpLmRhdGEgfHwgW107XHJcblx0XHRcdHZhciBtZXRhRGF0YSA9IG1ldGEuZGF0YTtcclxuXHRcdFx0dmFyIGksIGlsZW47XHJcblxyXG5cdFx0XHRmb3IgKGk9MCwgaWxlbj1kYXRhLmxlbmd0aDsgaTxpbGVuOyArK2kpIHtcclxuXHRcdFx0XHRtZXRhRGF0YVtpXSA9IG1ldGFEYXRhW2ldIHx8IG1lLmNyZWF0ZU1ldGFEYXRhKGkpO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRtZXRhLmRhdGFzZXQgPSBtZXRhLmRhdGFzZXQgfHwgbWUuY3JlYXRlTWV0YURhdGFzZXQoKTtcclxuXHRcdH0sXHJcblxyXG5cdFx0YWRkRWxlbWVudEFuZFJlc2V0OiBmdW5jdGlvbihpbmRleCkge1xyXG5cdFx0XHR2YXIgZWxlbWVudCA9IHRoaXMuY3JlYXRlTWV0YURhdGEoaW5kZXgpO1xyXG5cdFx0XHR0aGlzLmdldE1ldGEoKS5kYXRhLnNwbGljZShpbmRleCwgMCwgZWxlbWVudCk7XHJcblx0XHRcdHRoaXMudXBkYXRlRWxlbWVudChlbGVtZW50LCBpbmRleCwgdHJ1ZSk7XHJcblx0XHR9LFxyXG5cclxuXHRcdGJ1aWxkT3JVcGRhdGVFbGVtZW50czogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHZhciBtZSA9IHRoaXM7XHJcblx0XHRcdHZhciBkYXRhc2V0ID0gbWUuZ2V0RGF0YXNldCgpO1xyXG5cdFx0XHR2YXIgZGF0YSA9IGRhdGFzZXQuZGF0YSB8fCAoZGF0YXNldC5kYXRhID0gW10pO1xyXG5cclxuXHRcdFx0Ly8gSW4gb3JkZXIgdG8gY29ycmVjdGx5IGhhbmRsZSBkYXRhIGFkZGl0aW9uL2RlbGV0aW9uIGFuaW1hdGlvbiAoYW4gdGh1cyBzaW11bGF0ZVxyXG5cdFx0XHQvLyByZWFsLXRpbWUgY2hhcnRzKSwgd2UgbmVlZCB0byBtb25pdG9yIHRoZXNlIGRhdGEgbW9kaWZpY2F0aW9ucyBhbmQgc3luY2hyb25pemVcclxuXHRcdFx0Ly8gdGhlIGludGVybmFsIG1ldGEgZGF0YSBhY2NvcmRpbmdseS5cclxuXHRcdFx0aWYgKG1lLl9kYXRhICE9PSBkYXRhKSB7XHJcblx0XHRcdFx0aWYgKG1lLl9kYXRhKSB7XHJcblx0XHRcdFx0XHQvLyBUaGlzIGNhc2UgaGFwcGVucyB3aGVuIHRoZSB1c2VyIHJlcGxhY2VkIHRoZSBkYXRhIGFycmF5IGluc3RhbmNlLlxyXG5cdFx0XHRcdFx0dW5saXN0ZW5BcnJheUV2ZW50cyhtZS5fZGF0YSwgbWUpO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0bGlzdGVuQXJyYXlFdmVudHMoZGF0YSwgbWUpO1xyXG5cdFx0XHRcdG1lLl9kYXRhID0gZGF0YTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gUmUtc3luYyBtZXRhIGRhdGEgaW4gY2FzZSB0aGUgdXNlciByZXBsYWNlZCB0aGUgZGF0YSBhcnJheSBvciBpZiB3ZSBtaXNzZWRcclxuXHRcdFx0Ly8gYW55IHVwZGF0ZXMgYW5kIHNvIG1ha2Ugc3VyZSB0aGF0IHdlIGhhbmRsZSBudW1iZXIgb2YgZGF0YXBvaW50cyBjaGFuZ2luZy5cclxuXHRcdFx0bWUucmVzeW5jRWxlbWVudHMoKTtcclxuXHRcdH0sXHJcblxyXG5cdFx0dXBkYXRlOiBoZWxwZXJzLm5vb3AsXHJcblxyXG5cdFx0ZHJhdzogZnVuY3Rpb24oZWFzZSkge1xyXG5cdFx0XHR2YXIgZWFzaW5nRGVjaW1hbCA9IGVhc2UgfHwgMTtcclxuXHRcdFx0dmFyIGksIGxlbjtcclxuXHRcdFx0dmFyIG1ldGFEYXRhID0gdGhpcy5nZXRNZXRhKCkuZGF0YTtcclxuXHRcdFx0Zm9yIChpID0gMCwgbGVuID0gbWV0YURhdGEubGVuZ3RoOyBpIDwgbGVuOyArK2kpIHtcclxuXHRcdFx0XHRtZXRhRGF0YVtpXS50cmFuc2l0aW9uKGVhc2luZ0RlY2ltYWwpLmRyYXcoKTtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHJcblx0XHRyZW1vdmVIb3ZlclN0eWxlOiBmdW5jdGlvbihlbGVtZW50LCBlbGVtZW50T3B0cykge1xyXG5cdFx0XHR2YXIgZGF0YXNldCA9IHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0c1tlbGVtZW50Ll9kYXRhc2V0SW5kZXhdLFxyXG5cdFx0XHRcdGluZGV4ID0gZWxlbWVudC5faW5kZXgsXHJcblx0XHRcdFx0Y3VzdG9tID0gZWxlbWVudC5jdXN0b20gfHwge30sXHJcblx0XHRcdFx0dmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLmdldFZhbHVlQXRJbmRleE9yRGVmYXVsdCxcclxuXHRcdFx0XHRtb2RlbCA9IGVsZW1lbnQuX21vZGVsO1xyXG5cclxuXHRcdFx0bW9kZWwuYmFja2dyb3VuZENvbG9yID0gY3VzdG9tLmJhY2tncm91bmRDb2xvciA/IGN1c3RvbS5iYWNrZ3JvdW5kQ29sb3IgOiB2YWx1ZU9yRGVmYXVsdChkYXRhc2V0LmJhY2tncm91bmRDb2xvciwgaW5kZXgsIGVsZW1lbnRPcHRzLmJhY2tncm91bmRDb2xvcik7XHJcblx0XHRcdG1vZGVsLmJvcmRlckNvbG9yID0gY3VzdG9tLmJvcmRlckNvbG9yID8gY3VzdG9tLmJvcmRlckNvbG9yIDogdmFsdWVPckRlZmF1bHQoZGF0YXNldC5ib3JkZXJDb2xvciwgaW5kZXgsIGVsZW1lbnRPcHRzLmJvcmRlckNvbG9yKTtcclxuXHRcdFx0bW9kZWwuYm9yZGVyV2lkdGggPSBjdXN0b20uYm9yZGVyV2lkdGggPyBjdXN0b20uYm9yZGVyV2lkdGggOiB2YWx1ZU9yRGVmYXVsdChkYXRhc2V0LmJvcmRlcldpZHRoLCBpbmRleCwgZWxlbWVudE9wdHMuYm9yZGVyV2lkdGgpO1xyXG5cdFx0fSxcclxuXHJcblx0XHRzZXRIb3ZlclN0eWxlOiBmdW5jdGlvbihlbGVtZW50KSB7XHJcblx0XHRcdHZhciBkYXRhc2V0ID0gdGhpcy5jaGFydC5kYXRhLmRhdGFzZXRzW2VsZW1lbnQuX2RhdGFzZXRJbmRleF0sXHJcblx0XHRcdFx0aW5kZXggPSBlbGVtZW50Ll9pbmRleCxcclxuXHRcdFx0XHRjdXN0b20gPSBlbGVtZW50LmN1c3RvbSB8fCB7fSxcclxuXHRcdFx0XHR2YWx1ZU9yRGVmYXVsdCA9IGhlbHBlcnMuZ2V0VmFsdWVBdEluZGV4T3JEZWZhdWx0LFxyXG5cdFx0XHRcdGdldEhvdmVyQ29sb3IgPSBoZWxwZXJzLmdldEhvdmVyQ29sb3IsXHJcblx0XHRcdFx0bW9kZWwgPSBlbGVtZW50Ll9tb2RlbDtcclxuXHJcblx0XHRcdG1vZGVsLmJhY2tncm91bmRDb2xvciA9IGN1c3RvbS5ob3ZlckJhY2tncm91bmRDb2xvciA/IGN1c3RvbS5ob3ZlckJhY2tncm91bmRDb2xvciA6IHZhbHVlT3JEZWZhdWx0KGRhdGFzZXQuaG92ZXJCYWNrZ3JvdW5kQ29sb3IsIGluZGV4LCBnZXRIb3ZlckNvbG9yKG1vZGVsLmJhY2tncm91bmRDb2xvcikpO1xyXG5cdFx0XHRtb2RlbC5ib3JkZXJDb2xvciA9IGN1c3RvbS5ob3ZlckJvcmRlckNvbG9yID8gY3VzdG9tLmhvdmVyQm9yZGVyQ29sb3IgOiB2YWx1ZU9yRGVmYXVsdChkYXRhc2V0LmhvdmVyQm9yZGVyQ29sb3IsIGluZGV4LCBnZXRIb3ZlckNvbG9yKG1vZGVsLmJvcmRlckNvbG9yKSk7XHJcblx0XHRcdG1vZGVsLmJvcmRlcldpZHRoID0gY3VzdG9tLmhvdmVyQm9yZGVyV2lkdGggPyBjdXN0b20uaG92ZXJCb3JkZXJXaWR0aCA6IHZhbHVlT3JEZWZhdWx0KGRhdGFzZXQuaG92ZXJCb3JkZXJXaWR0aCwgaW5kZXgsIG1vZGVsLmJvcmRlcldpZHRoKTtcclxuXHRcdH0sXHJcblxyXG5cdFx0LyoqXHJcblx0XHQgKiBAcHJpdmF0ZVxyXG5cdFx0ICovXHJcblx0XHRyZXN5bmNFbGVtZW50czogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHZhciBtZSA9IHRoaXM7XHJcblx0XHRcdHZhciBtZXRhID0gbWUuZ2V0TWV0YSgpO1xyXG5cdFx0XHR2YXIgZGF0YSA9IG1lLmdldERhdGFzZXQoKS5kYXRhO1xyXG5cdFx0XHR2YXIgbnVtTWV0YSA9IG1ldGEuZGF0YS5sZW5ndGg7XHJcblx0XHRcdHZhciBudW1EYXRhID0gZGF0YS5sZW5ndGg7XHJcblxyXG5cdFx0XHRpZiAobnVtRGF0YSA8IG51bU1ldGEpIHtcclxuXHRcdFx0XHRtZXRhLmRhdGEuc3BsaWNlKG51bURhdGEsIG51bU1ldGEgLSBudW1EYXRhKTtcclxuXHRcdFx0fSBlbHNlIGlmIChudW1EYXRhID4gbnVtTWV0YSkge1xyXG5cdFx0XHRcdG1lLmluc2VydEVsZW1lbnRzKG51bU1ldGEsIG51bURhdGEgLSBudW1NZXRhKTtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHJcblx0XHQvKipcclxuXHRcdCAqIEBwcml2YXRlXHJcblx0XHQgKi9cclxuXHRcdGluc2VydEVsZW1lbnRzOiBmdW5jdGlvbihzdGFydCwgY291bnQpIHtcclxuXHRcdFx0Zm9yICh2YXIgaT0wOyBpPGNvdW50OyArK2kpIHtcclxuXHRcdFx0XHR0aGlzLmFkZEVsZW1lbnRBbmRSZXNldChzdGFydCArIGkpO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cclxuXHRcdC8qKlxyXG5cdFx0ICogQHByaXZhdGVcclxuXHRcdCAqL1xyXG5cdFx0b25EYXRhUHVzaDogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHRoaXMuaW5zZXJ0RWxlbWVudHModGhpcy5nZXREYXRhc2V0KCkuZGF0YS5sZW5ndGgtMSwgYXJndW1lbnRzLmxlbmd0aCk7XHJcblx0XHR9LFxyXG5cclxuXHRcdC8qKlxyXG5cdFx0ICogQHByaXZhdGVcclxuXHRcdCAqL1xyXG5cdFx0b25EYXRhUG9wOiBmdW5jdGlvbigpIHtcclxuXHRcdFx0dGhpcy5nZXRNZXRhKCkuZGF0YS5wb3AoKTtcclxuXHRcdH0sXHJcblxyXG5cdFx0LyoqXHJcblx0XHQgKiBAcHJpdmF0ZVxyXG5cdFx0ICovXHJcblx0XHRvbkRhdGFTaGlmdDogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHRoaXMuZ2V0TWV0YSgpLmRhdGEuc2hpZnQoKTtcclxuXHRcdH0sXHJcblxyXG5cdFx0LyoqXHJcblx0XHQgKiBAcHJpdmF0ZVxyXG5cdFx0ICovXHJcblx0XHRvbkRhdGFTcGxpY2U6IGZ1bmN0aW9uKHN0YXJ0LCBjb3VudCkge1xyXG5cdFx0XHR0aGlzLmdldE1ldGEoKS5kYXRhLnNwbGljZShzdGFydCwgY291bnQpO1xyXG5cdFx0XHR0aGlzLmluc2VydEVsZW1lbnRzKHN0YXJ0LCBhcmd1bWVudHMubGVuZ3RoIC0gMik7XHJcblx0XHR9LFxyXG5cclxuXHRcdC8qKlxyXG5cdFx0ICogQHByaXZhdGVcclxuXHRcdCAqL1xyXG5cdFx0b25EYXRhVW5zaGlmdDogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHRoaXMuaW5zZXJ0RWxlbWVudHMoMCwgYXJndW1lbnRzLmxlbmd0aCk7XHJcblx0XHR9XHJcblx0fSk7XHJcblxyXG5cdENoYXJ0LkRhdGFzZXRDb250cm9sbGVyLmV4dGVuZCA9IGhlbHBlcnMuaW5oZXJpdHM7XHJcbn07XHJcbiJdfQ==
/* global window: false */
'use strict';

module.exports = function (Chart) {

	var helpers = Chart.helpers;

	Chart.defaults.global.animation = {
		duration: 1000,
		easing: 'easeOutQuart',
		onProgress: helpers.noop,
		onComplete: helpers.noop
	};

	Chart.Animation = Chart.Element.extend({
		currentStep: null, // the current animation step
		numSteps: 60, // default number of steps
		easing: '', // the easing to use for this animation
		render: null, // render function used by the animation service

		onAnimationProgress: null, // user specified callback to fire on each step of the animation
		onAnimationComplete: null // user specified callback to fire when the animation finishes
	});

	Chart.animationService = {
		frameDuration: 17,
		animations: [],
		dropFrames: 0,
		request: null,

		/**
   * @function Chart.animationService.addAnimation
   * @param chartInstance {ChartController} the chart to animate
   * @param animationObject {IAnimation} the animation that we will animate
   * @param duration {Number} length of animation in ms
   * @param lazy {Boolean} if true, the chart is not marked as animating to enable more responsive interactions
   */
		addAnimation: function addAnimation(chartInstance, animationObject, duration, lazy) {
			var me = this;

			if (!lazy) {
				chartInstance.animating = true;
			}

			for (var index = 0; index < me.animations.length; ++index) {
				if (me.animations[index].chartInstance === chartInstance) {
					// replacing an in progress animation
					me.animations[index].animationObject = animationObject;
					return;
				}
			}

			me.animations.push({
				chartInstance: chartInstance,
				animationObject: animationObject
			});

			// If there are no animations queued, manually kickstart a digest, for lack of a better word
			if (me.animations.length === 1) {
				me.requestAnimationFrame();
			}
		},
		// Cancel the animation for a given chart instance
		cancelAnimation: function cancelAnimation(chartInstance) {
			var index = helpers.findIndex(this.animations, function (animationWrapper) {
				return animationWrapper.chartInstance === chartInstance;
			});

			if (index !== -1) {
				this.animations.splice(index, 1);
				chartInstance.animating = false;
			}
		},
		requestAnimationFrame: function requestAnimationFrame() {
			var me = this;
			if (me.request === null) {
				// Skip animation frame requests until the active one is executed.
				// This can happen when processing mouse events, e.g. 'mousemove'
				// and 'mouseout' events will trigger multiple renders.
				me.request = helpers.requestAnimFrame.call(window, function () {
					me.request = null;
					me.startDigest();
				});
			}
		},
		startDigest: function startDigest() {
			var me = this;

			var startTime = Date.now();
			var framesToDrop = 0;

			if (me.dropFrames > 1) {
				framesToDrop = Math.floor(me.dropFrames);
				me.dropFrames = me.dropFrames % 1;
			}

			var i = 0;
			while (i < me.animations.length) {
				if (me.animations[i].animationObject.currentStep === null) {
					me.animations[i].animationObject.currentStep = 0;
				}

				me.animations[i].animationObject.currentStep += 1 + framesToDrop;

				if (me.animations[i].animationObject.currentStep > me.animations[i].animationObject.numSteps) {
					me.animations[i].animationObject.currentStep = me.animations[i].animationObject.numSteps;
				}

				me.animations[i].animationObject.render(me.animations[i].chartInstance, me.animations[i].animationObject);
				if (me.animations[i].animationObject.onAnimationProgress && me.animations[i].animationObject.onAnimationProgress.call) {
					me.animations[i].animationObject.onAnimationProgress.call(me.animations[i].chartInstance, me.animations[i]);
				}

				if (me.animations[i].animationObject.currentStep === me.animations[i].animationObject.numSteps) {
					if (me.animations[i].animationObject.onAnimationComplete && me.animations[i].animationObject.onAnimationComplete.call) {
						me.animations[i].animationObject.onAnimationComplete.call(me.animations[i].chartInstance, me.animations[i]);
					}

					// executed the last frame. Remove the animation.
					me.animations[i].chartInstance.animating = false;

					me.animations.splice(i, 1);
				} else {
					++i;
				}
			}

			var endTime = Date.now();
			var dropFrames = (endTime - startTime) / me.frameDuration;

			me.dropFrames += dropFrames;

			// Do we have more stuff to animate?
			if (me.animations.length > 0) {
				me.requestAnimationFrame();
			}
		}
	};
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUuYW5pbWF0aW9uLmpzIl0sIm5hbWVzIjpbIm1vZHVsZSIsImV4cG9ydHMiLCJDaGFydCIsImhlbHBlcnMiLCJkZWZhdWx0cyIsImdsb2JhbCIsImFuaW1hdGlvbiIsImR1cmF0aW9uIiwiZWFzaW5nIiwib25Qcm9ncmVzcyIsIm5vb3AiLCJvbkNvbXBsZXRlIiwiQW5pbWF0aW9uIiwiRWxlbWVudCIsImV4dGVuZCIsImN1cnJlbnRTdGVwIiwibnVtU3RlcHMiLCJyZW5kZXIiLCJvbkFuaW1hdGlvblByb2dyZXNzIiwib25BbmltYXRpb25Db21wbGV0ZSIsImFuaW1hdGlvblNlcnZpY2UiLCJmcmFtZUR1cmF0aW9uIiwiYW5pbWF0aW9ucyIsImRyb3BGcmFtZXMiLCJyZXF1ZXN0IiwiYWRkQW5pbWF0aW9uIiwiY2hhcnRJbnN0YW5jZSIsImFuaW1hdGlvbk9iamVjdCIsImxhenkiLCJtZSIsImFuaW1hdGluZyIsImluZGV4IiwibGVuZ3RoIiwicHVzaCIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsImNhbmNlbEFuaW1hdGlvbiIsImZpbmRJbmRleCIsImFuaW1hdGlvbldyYXBwZXIiLCJzcGxpY2UiLCJyZXF1ZXN0QW5pbUZyYW1lIiwiY2FsbCIsIndpbmRvdyIsInN0YXJ0RGlnZXN0Iiwic3RhcnRUaW1lIiwiRGF0ZSIsIm5vdyIsImZyYW1lc1RvRHJvcCIsIk1hdGgiLCJmbG9vciIsImkiLCJlbmRUaW1lIl0sIm1hcHBpbmdzIjoiQUFBQTtBQUNBOztBQUVBQSxPQUFPQyxPQUFQLEdBQWlCLFVBQVNDLEtBQVQsRUFBZ0I7O0FBRWhDLEtBQUlDLFVBQVVELE1BQU1DLE9BQXBCOztBQUVBRCxPQUFNRSxRQUFOLENBQWVDLE1BQWYsQ0FBc0JDLFNBQXRCLEdBQWtDO0FBQ2pDQyxZQUFVLElBRHVCO0FBRWpDQyxVQUFRLGNBRnlCO0FBR2pDQyxjQUFZTixRQUFRTyxJQUhhO0FBSWpDQyxjQUFZUixRQUFRTztBQUphLEVBQWxDOztBQU9BUixPQUFNVSxT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LFdBQWpDLEtBQWlEYyxHQUFHUCxVQUFILENBQWMyQixDQUFkLEVBQWlCdEIsZUFBakIsQ0FBaUNYLFFBQXRGLEVBQWdHO0FBQy9GLFNBQUlhLEdBQUdQLFVBQUgsQ0FBYzJCLENBQWQsRUFBaUJ0QixlQUFqQixDQUFpQ1IsbUJBQWpDLElBQXdEVSxHQUFHUCxVQUFILENBQWMyQixDQUFkLEVBQWlCdEIsZUFBakIsQ0FBaUNSLG1CQUFqQyxDQUFxRHFCLElBQWpILEVBQXVIO0FBQ3RIWCxTQUFHUCxVQUFILENBQWMyQixDQUFkLEVBQWlCdEIsZUFBakIsQ0FBaUNSLG1CQUFqQyxDQUFxRHFCLElBQXJELENBQTBEWCxHQUFHUCxVQUFILENBQWMyQixDQUFkLEVBQWlCdkIsYUFBM0UsRUFBMEZHLEdBQUdQLFVBQUgsQ0FBYzJCLENBQWQsQ0FBMUY7QUFDQTs7QUFFRDtBQUNBcEIsUUFBR1AsVUFBSCxDQUFjMkIsQ0FBZCxFQUFpQnZCLGFBQWpCLENBQStCSSxTQUEvQixHQUEyQyxLQUEzQzs7QUFFQUQsUUFBR1AsVUFBSCxDQUFjZ0IsTUFBZCxDQUFxQlcsQ0FBckIsRUFBd0IsQ0FBeEI7QUFDQSxLQVRELE1BU087QUFDTixPQUFFQSxDQUFGO0FBQ0E7QUFDRDs7QUFFRCxPQUFJQyxVQUFVTixLQUFLQyxHQUFMLEVBQWQ7QUFDQSxPQUFJdEIsYUFBYSxDQUFDMkIsVUFBVVAsU0FBWCxJQUF3QmQsR0FBR1IsYUFBNUM7O0FBRUFRLE1BQUdOLFVBQUgsSUFBaUJBLFVBQWpCOztBQUVBO0FBQ0EsT0FBSU0sR0FBR1AsVUFBSCxDQUFjVSxNQUFkLEdBQXVCLENBQTNCLEVBQThCO0FBQzdCSCxPQUFHSyxxQkFBSDtBQUNBO0FBQ0Q7QUFoSHVCLEVBQXpCO0FBa0hBLENBdklEIiwiZmlsZSI6ImNvcmUuYW5pbWF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZ2xvYmFsIHdpbmRvdzogZmFsc2UgKi9cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkge1xyXG5cclxuXHR2YXIgaGVscGVycyA9IENoYXJ0LmhlbHBlcnM7XHJcblxyXG5cdENoYXJ0LmRlZmF1bHRzLmdsb2JhbC5hbmltYXRpb24gPSB7XHJcblx0XHRkdXJhdGlvbjogMTAwMCxcclxuXHRcdGVhc2luZzogJ2Vhc2VPdXRRdWFydCcsXHJcblx0XHRvblByb2dyZXNzOiBoZWxwZXJzLm5vb3AsXHJcblx0XHRvbkNvbXBsZXRlOiBoZWxwZXJzLm5vb3BcclxuXHR9O1xyXG5cclxuXHRDaGFydC5BbmltYXRpb24gPSBDaGFydC5FbGVtZW50LmV4dGVuZCh7XHJcblx0XHRjdXJyZW50U3RlcDogbnVsbCwgLy8gdGhlIGN1cnJlbnQgYW5pbWF0aW9uIHN0ZXBcclxuXHRcdG51bVN0ZXBzOiA2MCwgLy8gZGVmYXVsdCBudW1iZXIgb2Ygc3RlcHNcclxuXHRcdGVhc2luZzogJycsIC8vIHRoZSBlYXNpbmcgdG8gdXNlIGZvciB0aGlzIGFuaW1hdGlvblxyXG5cdFx0cmVuZGVyOiBudWxsLCAvLyByZW5kZXIgZnVuY3Rpb24gdXNlZCBieSB0aGUgYW5pbWF0aW9uIHNlcnZpY2VcclxuXHJcblx0XHRvbkFuaW1hdGlvblByb2dyZXNzOiBudWxsLCAvLyB1c2VyIHNwZWNpZmllZCBjYWxsYmFjayB0byBmaXJlIG9uIGVhY2ggc3RlcCBvZiB0aGUgYW5pbWF0aW9uXHJcblx0XHRvbkFuaW1hdGlvbkNvbXBsZXRlOiBudWxsIC8vIHVzZXIgc3BlY2lmaWVkIGNhbGxiYWNrIHRvIGZpcmUgd2hlbiB0aGUgYW5pbWF0aW9uIGZpbmlzaGVzXHJcblx0fSk7XHJcblxyXG5cdENoYXJ0LmFuaW1hdGlvblNlcnZpY2UgPSB7XHJcblx0XHRmcmFtZUR1cmF0aW9uOiAxNyxcclxuXHRcdGFuaW1hdGlvbnM6IFtdLFxyXG5cdFx0ZHJvcEZyYW1lczogMCxcclxuXHRcdHJlcXVlc3Q6IG51bGwsXHJcblxyXG5cdFx0LyoqXHJcblx0XHQgKiBAZnVuY3Rpb24gQ2hhcnQuYW5pbWF0aW9uU2VydmljZS5hZGRBbmltYXRpb25cclxuXHRcdCAqIEBwYXJhbSBjaGFydEluc3RhbmNlIHtDaGFydENvbnRyb2xsZXJ9IHRoZSBjaGFydCB0byBhbmltYXRlXHJcblx0XHQgKiBAcGFyYW0gYW5pbWF0aW9uT2JqZWN0IHtJQW5pbWF0aW9ufSB0aGUgYW5pbWF0aW9uIHRoYXQgd2Ugd2lsbCBhbmltYXRlXHJcblx0XHQgKiBAcGFyYW0gZHVyYXRpb24ge051bWJlcn0gbGVuZ3RoIG9mIGFuaW1hdGlvbiBpbiBtc1xyXG5cdFx0ICogQHBhcmFtIGxhenkge0Jvb2xlYW59IGlmIHRydWUsIHRoZSBjaGFydCBpcyBub3QgbWFya2VkIGFzIGFuaW1hdGluZyB0byBlbmFibGUgbW9yZSByZXNwb25zaXZlIGludGVyYWN0aW9uc1xyXG5cdFx0ICovXHJcblx0XHRhZGRBbmltYXRpb246IGZ1bmN0aW9uKGNoYXJ0SW5zdGFuY2UsIGFuaW1hdGlvbk9iamVjdCwgZHVyYXRpb24sIGxhenkpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHJcblx0XHRcdGlmICghbGF6eSkge1xyXG5cdFx0XHRcdGNoYXJ0SW5zdGFuY2UuYW5pbWF0aW5nID0gdHJ1ZTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Zm9yICh2YXIgaW5kZXggPSAwOyBpbmRleCA8IG1lLmFuaW1hdGlvbnMubGVuZ3RoOyArK2luZGV4KSB7XHJcblx0XHRcdFx0aWYgKG1lLmFuaW1hdGlvbnNbaW5kZXhdLmNoYXJ0SW5zdGFuY2UgPT09IGNoYXJ0SW5zdGFuY2UpIHtcclxuXHRcdFx0XHRcdC8vIHJlcGxhY2luZyBhbiBpbiBwcm9ncmVzcyBhbmltYXRpb25cclxuXHRcdFx0XHRcdG1lLmFuaW1hdGlvbnNbaW5kZXhdLmFuaW1hdGlvbk9iamVjdCA9IGFuaW1hdGlvbk9iamVjdDtcclxuXHRcdFx0XHRcdHJldHVybjtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdG1lLmFuaW1hdGlvbnMucHVzaCh7XHJcblx0XHRcdFx0Y2hhcnRJbnN0YW5jZTogY2hhcnRJbnN0YW5jZSxcclxuXHRcdFx0XHRhbmltYXRpb25PYmplY3Q6IGFuaW1hdGlvbk9iamVjdFxyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdC8vIElmIHRoZXJlIGFyZSBubyBhbmltYXRpb25zIHF1ZXVlZCwgbWFudWFsbHkga2lja3N0YXJ0IGEgZGlnZXN0LCBmb3IgbGFjayBvZiBhIGJldHRlciB3b3JkXHJcblx0XHRcdGlmIChtZS5hbmltYXRpb25zLmxlbmd0aCA9PT0gMSkge1xyXG5cdFx0XHRcdG1lLnJlcXVlc3RBbmltYXRpb25GcmFtZSgpO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cdFx0Ly8gQ2FuY2VsIHRoZSBhbmltYXRpb24gZm9yIGEgZ2l2ZW4gY2hhcnQgaW5zdGFuY2VcclxuXHRcdGNhbmNlbEFuaW1hdGlvbjogZnVuY3Rpb24oY2hhcnRJbnN0YW5jZSkge1xyXG5cdFx0XHR2YXIgaW5kZXggPSBoZWxwZXJzLmZpbmRJbmRleCh0aGlzLmFuaW1hdGlvbnMsIGZ1bmN0aW9uKGFuaW1hdGlvbldyYXBwZXIpIHtcclxuXHRcdFx0XHRyZXR1cm4gYW5pbWF0aW9uV3JhcHBlci5jaGFydEluc3RhbmNlID09PSBjaGFydEluc3RhbmNlO1xyXG5cdFx0XHR9KTtcclxuXHJcblx0XHRcdGlmIChpbmRleCAhPT0gLTEpIHtcclxuXHRcdFx0XHR0aGlzLmFuaW1hdGlvbnMuc3BsaWNlKGluZGV4LCAxKTtcclxuXHRcdFx0XHRjaGFydEluc3RhbmNlLmFuaW1hdGluZyA9IGZhbHNlO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cdFx0cmVxdWVzdEFuaW1hdGlvbkZyYW1lOiBmdW5jdGlvbigpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0aWYgKG1lLnJlcXVlc3QgPT09IG51bGwpIHtcclxuXHRcdFx0XHQvLyBTa2lwIGFuaW1hdGlvbiBmcmFtZSByZXF1ZXN0cyB1bnRpbCB0aGUgYWN0aXZlIG9uZSBpcyBleGVjdXRlZC5cclxuXHRcdFx0XHQvLyBUaGlzIGNhbiBoYXBwZW4gd2hlbiBwcm9jZXNzaW5nIG1vdXNlIGV2ZW50cywgZS5nLiAnbW91c2Vtb3ZlJ1xyXG5cdFx0XHRcdC8vIGFuZCAnbW91c2VvdXQnIGV2ZW50cyB3aWxsIHRyaWdnZXIgbXVsdGlwbGUgcmVuZGVycy5cclxuXHRcdFx0XHRtZS5yZXF1ZXN0ID0gaGVscGVycy5yZXF1ZXN0QW5pbUZyYW1lLmNhbGwod2luZG93LCBmdW5jdGlvbigpIHtcclxuXHRcdFx0XHRcdG1lLnJlcXVlc3QgPSBudWxsO1xyXG5cdFx0XHRcdFx0bWUuc3RhcnREaWdlc3QoKTtcclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fVxyXG5cdFx0fSxcclxuXHRcdHN0YXJ0RGlnZXN0OiBmdW5jdGlvbigpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHJcblx0XHRcdHZhciBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xyXG5cdFx0XHR2YXIgZnJhbWVzVG9Ecm9wID0gMDtcclxuXHJcblx0XHRcdGlmIChtZS5kcm9wRnJhbWVzID4gMSkge1xyXG5cdFx0XHRcdGZyYW1lc1RvRHJvcCA9IE1hdGguZmxvb3IobWUuZHJvcEZyYW1lcyk7XHJcblx0XHRcdFx0bWUuZHJvcEZyYW1lcyA9IG1lLmRyb3BGcmFtZXMgJSAxO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHR2YXIgaSA9IDA7XHJcblx0XHRcdHdoaWxlIChpIDwgbWUuYW5pbWF0aW9ucy5sZW5ndGgpIHtcclxuXHRcdFx0XHRpZiAobWUuYW5pbWF0aW9uc1tpXS5hbmltYXRpb25PYmplY3QuY3VycmVudFN0ZXAgPT09IG51bGwpIHtcclxuXHRcdFx0XHRcdG1lLmFuaW1hdGlvbnNbaV0uYW5pbWF0aW9uT2JqZWN0LmN1cnJlbnRTdGVwID0gMDtcclxuXHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdG1lLmFuaW1hdGlvbnNbaV0uYW5pbWF0aW9uT2JqZWN0LmN1cnJlbnRTdGVwICs9IDEgKyBmcmFtZXNUb0Ryb3A7XHJcblxyXG5cdFx0XHRcdGlmIChtZS5hbmltYXRpb25zW2ldLmFuaW1hdGlvbk9iamVjdC5jdXJyZW50U3RlcCA+IG1lLmFuaW1hdGlvbnNbaV0uYW5pbWF0aW9uT2JqZWN0Lm51bVN0ZXBzKSB7XHJcblx0XHRcdFx0XHRtZS5hbmltYXRpb25zW2ldLmFuaW1hdGlvbk9iamVjdC5jdXJyZW50U3RlcCA9IG1lLmFuaW1hdGlvbnNbaV0uYW5pbWF0aW9uT2JqZWN0Lm51bVN0ZXBzO1xyXG5cdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0bWUuYW5pbWF0aW9uc1tpXS5hbmltYXRpb25PYmplY3QucmVuZGVyKG1lLmFuaW1hdGlvbnNbaV0uY2hhcnRJbnN0YW5jZSwgbWUuYW5pbWF0aW9uc1tpXS5hbmltYXRpb25PYmplY3QpO1xyXG5cdFx0XHRcdGlmIChtZS5hbmltYXRpb25zW2ldLmFuaW1hdGlvbk9iamVjdC5vbkFuaW1hdGlvblByb2dyZXNzICYmIG1lLmFuaW1hdGlvbnNbaV0uYW5pbWF0aW9uT2JqZWN0Lm9uQW5pbWF0aW9uUHJvZ3Jlc3MuY2FsbCkge1xyXG5cdFx0XHRcdFx0bWUuYW5pbWF0aW9uc1tpXS5hbmltYXRpb25PYmplY3Qub25BbmltYXRpb25Qcm9ncmVzcy5jYWxsKG1lLmFuaW1hdGlvbnNbaV0uY2hhcnRJbnN0YW5jZSwgbWUuYW5pbWF0aW9uc1tpXSk7XHJcblx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRpZiAobWUuYW5pbWF0aW9uc1tpXS5hbmltYXRpb25PYmplY3QuY3VycmVudFN0ZXAgPT09IG1lLmFuaW1hdGlvbnNbaV0uYW5pbWF0aW9uT2JqZWN0Lm51bVN0ZXBzKSB7XHJcblx0XHRcdFx0XHRpZiAobWUuYW5pbWF0aW9uc1tpXS5hbmltYXRpb25PYmplY3Qub25BbmltYXRpb25Db21wbGV0ZSAmJiBtZS5hbmltYXRpb25zW2ldLmFuaW1hdGlvbk9iamVjdC5vbkFuaW1hdGlvbkNvbXBsZXRlLmNhbGwpIHtcclxuXHRcdFx0XHRcdFx0bWUuYW5pbWF0aW9uc1tpXS5hbmltYXRpb25PYmplY3Qub25BbmltYXRpb25Db21wbGV0ZS5jYWxsKG1lLmFuaW1hdGlvbnNbaV0uY2hhcnRJbnN0YW5jZSwgbWUuYW5pbWF0aW9uc1tpXSk7XHJcblx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0Ly8gZXhlY3V0ZWQgdGhlIGxhc3QgZnJhbWUuIFJlbW92ZSB0aGUgYW5pbWF0aW9uLlxyXG5cdFx0XHRcdFx0bWUuYW5pbWF0aW9uc1tpXS5jaGFydEluc3RhbmNlLmFuaW1hdGluZyA9IGZhbHNlO1xyXG5cclxuXHRcdFx0XHRcdG1lLmFuaW1hdGlvbnMuc3BsaWNlKGksIDEpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHQrK2k7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHR2YXIgZW5kVGltZSA9IERhdGUubm93KCk7XHJcblx0XHRcdHZhciBkcm9wRnJhbWVzID0gKGVuZFRpbWUgLSBzdGFydFRpbWUpIC8gbWUuZnJhbWVEdXJhdGlvbjtcclxuXHJcblx0XHRcdG1lLmRyb3BGcmFtZXMgKz0gZHJvcEZyYW1lcztcclxuXHJcblx0XHRcdC8vIERvIHdlIGhhdmUgbW9yZSBzdHVmZiB0byBhbmltYXRlP1xyXG5cdFx0XHRpZiAobWUuYW5pbWF0aW9ucy5sZW5ndGggPiAwKSB7XHJcblx0XHRcdFx0bWUucmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHR9O1xyXG59O1xyXG4iXX0=
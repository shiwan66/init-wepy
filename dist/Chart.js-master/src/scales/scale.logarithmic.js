'use strict';

module.exports = function (Chart) {

	var helpers = Chart.helpers;

	var defaultConfig = {
		position: 'left',

		// label settings
		ticks: {
			callback: Chart.Ticks.formatters.logarithmic
		}
	};

	var LogarithmicScale = Chart.Scale.extend({
		determineDataLimits: function determineDataLimits() {
			var me = this;
			var opts = me.options;
			var tickOpts = opts.ticks;
			var chart = me.chart;
			var data = chart.data;
			var datasets = data.datasets;
			var getValueOrDefault = helpers.getValueOrDefault;
			var isHorizontal = me.isHorizontal();
			function IDMatches(meta) {
				return isHorizontal ? meta.xAxisID === me.id : meta.yAxisID === me.id;
			}

			// Calculate Range
			me.min = null;
			me.max = null;
			me.minNotZero = null;

			if (opts.stacked) {
				var valuesPerType = {};

				helpers.each(datasets, function (dataset, datasetIndex) {
					var meta = chart.getDatasetMeta(datasetIndex);
					if (chart.isDatasetVisible(datasetIndex) && IDMatches(meta)) {
						if (valuesPerType[meta.type] === undefined) {
							valuesPerType[meta.type] = [];
						}

						helpers.each(dataset.data, function (rawValue, index) {
							var values = valuesPerType[meta.type];
							var value = +me.getRightValue(rawValue);
							if (isNaN(value) || meta.data[index].hidden) {
								return;
							}

							values[index] = values[index] || 0;

							if (opts.relativePoints) {
								values[index] = 100;
							} else {
								// Don't need to split positive and negative since the log scale can't handle a 0 crossing
								values[index] += value;
							}
						});
					}
				});

				helpers.each(valuesPerType, function (valuesForType) {
					var minVal = helpers.min(valuesForType);
					var maxVal = helpers.max(valuesForType);
					me.min = me.min === null ? minVal : Math.min(me.min, minVal);
					me.max = me.max === null ? maxVal : Math.max(me.max, maxVal);
				});
			} else {
				helpers.each(datasets, function (dataset, datasetIndex) {
					var meta = chart.getDatasetMeta(datasetIndex);
					if (chart.isDatasetVisible(datasetIndex) && IDMatches(meta)) {
						helpers.each(dataset.data, function (rawValue, index) {
							var value = +me.getRightValue(rawValue);
							if (isNaN(value) || meta.data[index].hidden) {
								return;
							}

							if (me.min === null) {
								me.min = value;
							} else if (value < me.min) {
								me.min = value;
							}

							if (me.max === null) {
								me.max = value;
							} else if (value > me.max) {
								me.max = value;
							}

							if (value !== 0 && (me.minNotZero === null || value < me.minNotZero)) {
								me.minNotZero = value;
							}
						});
					}
				});
			}

			me.min = getValueOrDefault(tickOpts.min, me.min);
			me.max = getValueOrDefault(tickOpts.max, me.max);

			if (me.min === me.max) {
				if (me.min !== 0 && me.min !== null) {
					me.min = Math.pow(10, Math.floor(helpers.log10(me.min)) - 1);
					me.max = Math.pow(10, Math.floor(helpers.log10(me.max)) + 1);
				} else {
					me.min = 1;
					me.max = 10;
				}
			}
		},
		buildTicks: function buildTicks() {
			var me = this;
			var opts = me.options;
			var tickOpts = opts.ticks;

			var generationOptions = {
				min: tickOpts.min,
				max: tickOpts.max
			};
			var ticks = me.ticks = Chart.Ticks.generators.logarithmic(generationOptions, me);

			if (!me.isHorizontal()) {
				// We are in a vertical orientation. The top value is the highest. So reverse the array
				ticks.reverse();
			}

			// At this point, we need to update our max and min given the tick values since we have expanded the
			// range of the scale
			me.max = helpers.max(ticks);
			me.min = helpers.min(ticks);

			if (tickOpts.reverse) {
				ticks.reverse();

				me.start = me.max;
				me.end = me.min;
			} else {
				me.start = me.min;
				me.end = me.max;
			}
		},
		convertTicksToLabels: function convertTicksToLabels() {
			this.tickValues = this.ticks.slice();

			Chart.Scale.prototype.convertTicksToLabels.call(this);
		},
		// Get the correct tooltip label
		getLabelForIndex: function getLabelForIndex(index, datasetIndex) {
			return +this.getRightValue(this.chart.data.datasets[datasetIndex].data[index]);
		},
		getPixelForTick: function getPixelForTick(index) {
			return this.getPixelForValue(this.tickValues[index]);
		},
		getPixelForValue: function getPixelForValue(value) {
			var me = this;
			var innerDimension;
			var pixel;

			var start = me.start;
			var newVal = +me.getRightValue(value);
			var range;
			var paddingTop = me.paddingTop;
			var paddingBottom = me.paddingBottom;
			var paddingLeft = me.paddingLeft;
			var opts = me.options;
			var tickOpts = opts.ticks;

			if (me.isHorizontal()) {
				range = helpers.log10(me.end) - helpers.log10(start); // todo: if start === 0
				if (newVal === 0) {
					pixel = me.left + paddingLeft;
				} else {
					innerDimension = me.width - (paddingLeft + me.paddingRight);
					pixel = me.left + innerDimension / range * (helpers.log10(newVal) - helpers.log10(start));
					pixel += paddingLeft;
				}
			} else {
				// Bottom - top since pixels increase downward on a screen
				innerDimension = me.height - (paddingTop + paddingBottom);
				if (start === 0 && !tickOpts.reverse) {
					range = helpers.log10(me.end) - helpers.log10(me.minNotZero);
					if (newVal === start) {
						pixel = me.bottom - paddingBottom;
					} else if (newVal === me.minNotZero) {
						pixel = me.bottom - paddingBottom - innerDimension * 0.02;
					} else {
						pixel = me.bottom - paddingBottom - innerDimension * 0.02 - innerDimension * 0.98 / range * (helpers.log10(newVal) - helpers.log10(me.minNotZero));
					}
				} else if (me.end === 0 && tickOpts.reverse) {
					range = helpers.log10(me.start) - helpers.log10(me.minNotZero);
					if (newVal === me.end) {
						pixel = me.top + paddingTop;
					} else if (newVal === me.minNotZero) {
						pixel = me.top + paddingTop + innerDimension * 0.02;
					} else {
						pixel = me.top + paddingTop + innerDimension * 0.02 + innerDimension * 0.98 / range * (helpers.log10(newVal) - helpers.log10(me.minNotZero));
					}
				} else {
					range = helpers.log10(me.end) - helpers.log10(start);
					innerDimension = me.height - (paddingTop + paddingBottom);
					pixel = me.bottom - paddingBottom - innerDimension / range * (helpers.log10(newVal) - helpers.log10(start));
				}
			}
			return pixel;
		},
		getValueForPixel: function getValueForPixel(pixel) {
			var me = this;
			var range = helpers.log10(me.end) - helpers.log10(me.start);
			var value, innerDimension;

			if (me.isHorizontal()) {
				innerDimension = me.width - (me.paddingLeft + me.paddingRight);
				value = me.start * Math.pow(10, (pixel - me.left - me.paddingLeft) * range / innerDimension);
			} else {
				// todo: if start === 0
				innerDimension = me.height - (me.paddingTop + me.paddingBottom);
				value = Math.pow(10, (me.bottom - me.paddingBottom - pixel) * range / innerDimension) / me.start;
			}
			return value;
		}
	});
	Chart.scaleService.registerScaleType('logarithmic', LogarithmicScale, defaultConfig);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjYWxlLmxvZ2FyaXRobWljLmpzIl0sIm5hbWVzIjpbIm1vZHVsZSIsImV4cG9ydHMiLCJDaGFydCIsImhlbHBlcnMiLCJkZWZhdWx0Q29uZmlnIiwicG9zaXRpb24iLCJ0aWNrcyIsImNhbGxiYWNrIiwiVGlja3MiLCJmb3JtYXR0ZXJzIiwibG9nYXJpdGhtaWMiLCJMb2dhcml0aG1pY1NjYWxlIiwiU2NhbGUiLCJleHRlbmQiLCJkZXRlcm1pbmVEYXRhTGltaXRzIiwibWUiLCJvcHRzIiwib3B0aW9ucyIsInRpY2tPcHRzIiwiY2hhcnQiLCJkYXRhIiwiZGF0YXNldHMiLCJnZXRWYWx1ZU9yRGVmYXVsdCIsImlzSG9yaXpvbnRhbCIsIklETWF0Y2hlcyIsIm1ldGEiLCJ4QXhpc0lEIiwiaWQiLCJ5QXhpc0lEIiwibWluIiwibWF4IiwibWluTm90WmVybyIsInN0YWNrZWQiLCJ2YWx1ZXNQZXJUeXBlIiwiZWFjaCIsImRhdGFzZXQiLCJkYXRhc2V0SW5kZXgiLCJnZXREYXRhc2V0TWV0YSIsImlzRGF0YXNldFZpc2libGUiLCJ0eXBlIiwidW5kZWZpbmVkIiwicmF3VmFsdWUiLCJpbmRleCIsInZhbHVlcyIsInZhbHVlIiwiZ2V0UmlnaHRWYWx1ZSIsImlzTmFOIiwiaGlkZGVuIiwicmVsYXRpdmVQb2ludHMiLCJ2YWx1ZXNGb3JUeXBlIiwibWluVmFsIiwibWF4VmFsIiwiTWF0aCIsInBvdyIsImZsb29yIiwibG9nMTAiLCJidWlsZFRpY2tzIiwiZ2VuZXJhdGlvbk9wdGlvbnMiLCJnZW5lcmF0b3JzIiwicmV2ZXJzZSIsInN0YXJ0IiwiZW5kIiwiY29udmVydFRpY2tzVG9MYWJlbHMiLCJ0aWNrVmFsdWVzIiwic2xpY2UiLCJwcm90b3R5cGUiLCJjYWxsIiwiZ2V0TGFiZWxGb3JJbmRleCIsImdldFBpeGVsRm9yVGljayIsImdldFBpeGVsRm9yVmFsdWUiLCJpbm5lckRpbWVuc2lvbiIsInBpeGVsIiwibmV3VmFsIiwicmFuZ2UiLCJwYWRkaW5nVG9wIiwicGFkZGluZ0JvdHRvbSIsInBhZGRpbmdMZWZ0IiwibGVmdCIsIndpZHRoIiwicGFkZGluZ1JpZ2h0IiwiaGVpZ2h0IiwiYm90dG9tIiwidG9wIiwiZ2V0VmFsdWVGb3JQaXhlbCIsInNjYWxlU2VydmljZSIsInJlZ2lzdGVyU2NhbGVUeXBlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsT0FBT0MsT0FBUCxHQUFpQixVQUFTQyxLQUFULEVBQWdCOztBQUVoQyxLQUFJQyxVQUFVRCxNQUFNQyxPQUFwQjs7QUFFQSxLQUFJQyxnQkFBZ0I7QUFDbkJDLFlBQVUsTUFEUzs7QUFHbkI7QUFDQUMsU0FBTztBQUNOQyxhQUFVTCxNQUFNTSxLQUFOLENBQVlDLFVBQVosQ0FBdUJDO0FBRDNCO0FBSlksRUFBcEI7O0FBU0EsS0FBSUMsbUJBQW1CVCxNQUFNVSxLQUFOLENBQVlDLE1BQVosQ0FBbUI7QUFDekNDLHVCQUFxQiwrQkFBVztBQUMvQixPQUFJQyxLQUFLLElBQVQ7QUFDQSxPQUFJQyxPQUFPRCxHQUFHRSxPQUFkO0FBQ0EsT0FBSUMsV0FBV0YsS0FBS1YsS0FBcEI7QUFDQSxPQUFJYSxRQUFRSixHQUFHSSxLQUFmO0FBQ0EsT0FBSUMsT0FBT0QsTUFBTUMsSUFBakI7QUFDQSxPQUFJQyxXQUFXRCxLQUFLQyxRQUFwQjtBQUNBLE9BQUlDLG9CQUFvQm5CLFFBQVFtQixpQkFBaEM7QUFDQSxPQUFJQyxlQUFlUixHQUFHUSxZQUFILEVBQW5CO0FBQ0EsWUFBU0MsU0FBVCxDQUFtQkMsSUFBbkIsRUFBeUI7QUFDeEIsV0FBT0YsZUFBZUUsS0FBS0MsT0FBTCxLQUFpQlgsR0FBR1ksRUFBbkMsR0FBd0NGLEtBQUtHLE9BQUwsS0FBaUJiLEdBQUdZLEVBQW5FO0FBQ0E7O0FBRUQ7QUFDQVosTUFBR2MsR0FBSCxHQUFTLElBQVQ7QUFDQWQsTUFBR2UsR0FBSCxHQUFTLElBQVQ7QUFDQWYsTUFBR2dCLFVBQUgsR0FBZ0IsSUFBaEI7O0FBRUEsT0FBSWYsS0FBS2dCLE9BQVQsRUFBa0I7QUFDakIsUUFBSUMsZ0JBQWdCLEVBQXBCOztBQUVBOUIsWUFBUStCLElBQVIsQ0FBYWIsUUFBYixFQUF1QixVQUFTYyxPQUFULEVBQWtCQyxZQUFsQixFQUFnQztBQUN0RCxTQUFJWCxPQUFPTixNQUFNa0IsY0FBTixDQUFxQkQsWUFBckIsQ0FBWDtBQUNBLFNBQUlqQixNQUFNbUIsZ0JBQU4sQ0FBdUJGLFlBQXZCLEtBQXdDWixVQUFVQyxJQUFWLENBQTVDLEVBQTZEO0FBQzVELFVBQUlRLGNBQWNSLEtBQUtjLElBQW5CLE1BQTZCQyxTQUFqQyxFQUE0QztBQUMzQ1AscUJBQWNSLEtBQUtjLElBQW5CLElBQTJCLEVBQTNCO0FBQ0E7O0FBRURwQyxjQUFRK0IsSUFBUixDQUFhQyxRQUFRZixJQUFyQixFQUEyQixVQUFTcUIsUUFBVCxFQUFtQkMsS0FBbkIsRUFBMEI7QUFDcEQsV0FBSUMsU0FBU1YsY0FBY1IsS0FBS2MsSUFBbkIsQ0FBYjtBQUNBLFdBQUlLLFFBQVEsQ0FBQzdCLEdBQUc4QixhQUFILENBQWlCSixRQUFqQixDQUFiO0FBQ0EsV0FBSUssTUFBTUYsS0FBTixLQUFnQm5CLEtBQUtMLElBQUwsQ0FBVXNCLEtBQVYsRUFBaUJLLE1BQXJDLEVBQTZDO0FBQzVDO0FBQ0E7O0FBRURKLGNBQU9ELEtBQVAsSUFBZ0JDLE9BQU9ELEtBQVAsS0FBaUIsQ0FBakM7O0FBRUEsV0FBSTFCLEtBQUtnQyxjQUFULEVBQXlCO0FBQ3hCTCxlQUFPRCxLQUFQLElBQWdCLEdBQWhCO0FBQ0EsUUFGRCxNQUVPO0FBQ047QUFDQUMsZUFBT0QsS0FBUCxLQUFpQkUsS0FBakI7QUFDQTtBQUNELE9BZkQ7QUFnQkE7QUFDRCxLQXhCRDs7QUEwQkF6QyxZQUFRK0IsSUFBUixDQUFhRCxhQUFiLEVBQTRCLFVBQVNnQixhQUFULEVBQXdCO0FBQ25ELFNBQUlDLFNBQVMvQyxRQUFRMEIsR0FBUixDQUFZb0IsYUFBWixDQUFiO0FBQ0EsU0FBSUUsU0FBU2hELFFBQVEyQixHQUFSLENBQVltQixhQUFaLENBQWI7QUFDQWxDLFFBQUdjLEdBQUgsR0FBU2QsR0FBR2MsR0FBSCxLQUFXLElBQVgsR0FBa0JxQixNQUFsQixHQUEyQkUsS0FBS3ZCLEdBQUwsQ0FBU2QsR0FBR2MsR0FBWixFQUFpQnFCLE1BQWpCLENBQXBDO0FBQ0FuQyxRQUFHZSxHQUFILEdBQVNmLEdBQUdlLEdBQUgsS0FBVyxJQUFYLEdBQWtCcUIsTUFBbEIsR0FBMkJDLEtBQUt0QixHQUFMLENBQVNmLEdBQUdlLEdBQVosRUFBaUJxQixNQUFqQixDQUFwQztBQUNBLEtBTEQ7QUFPQSxJQXBDRCxNQW9DTztBQUNOaEQsWUFBUStCLElBQVIsQ0FBYWIsUUFBYixFQUF1QixVQUFTYyxPQUFULEVBQWtCQyxZQUFsQixFQUFnQztBQUN0RCxTQUFJWCxPQUFPTixNQUFNa0IsY0FBTixDQUFxQkQsWUFBckIsQ0FBWDtBQUNBLFNBQUlqQixNQUFNbUIsZ0JBQU4sQ0FBdUJGLFlBQXZCLEtBQXdDWixVQUFVQyxJQUFWLENBQTVDLEVBQTZEO0FBQzVEdEIsY0FBUStCLElBQVIsQ0FBYUMsUUFBUWYsSUFBckIsRUFBMkIsVUFBU3FCLFFBQVQsRUFBbUJDLEtBQW5CLEVBQTBCO0FBQ3BELFdBQUlFLFFBQVEsQ0FBQzdCLEdBQUc4QixhQUFILENBQWlCSixRQUFqQixDQUFiO0FBQ0EsV0FBSUssTUFBTUYsS0FBTixLQUFnQm5CLEtBQUtMLElBQUwsQ0FBVXNCLEtBQVYsRUFBaUJLLE1BQXJDLEVBQTZDO0FBQzVDO0FBQ0E7O0FBRUQsV0FBSWhDLEdBQUdjLEdBQUgsS0FBVyxJQUFmLEVBQXFCO0FBQ3BCZCxXQUFHYyxHQUFILEdBQVNlLEtBQVQ7QUFDQSxRQUZELE1BRU8sSUFBSUEsUUFBUTdCLEdBQUdjLEdBQWYsRUFBb0I7QUFDMUJkLFdBQUdjLEdBQUgsR0FBU2UsS0FBVDtBQUNBOztBQUVELFdBQUk3QixHQUFHZSxHQUFILEtBQVcsSUFBZixFQUFxQjtBQUNwQmYsV0FBR2UsR0FBSCxHQUFTYyxLQUFUO0FBQ0EsUUFGRCxNQUVPLElBQUlBLFFBQVE3QixHQUFHZSxHQUFmLEVBQW9CO0FBQzFCZixXQUFHZSxHQUFILEdBQVNjLEtBQVQ7QUFDQTs7QUFFRCxXQUFJQSxVQUFVLENBQVYsS0FBZ0I3QixHQUFHZ0IsVUFBSCxLQUFrQixJQUFsQixJQUEwQmEsUUFBUTdCLEdBQUdnQixVQUFyRCxDQUFKLEVBQXNFO0FBQ3JFaEIsV0FBR2dCLFVBQUgsR0FBZ0JhLEtBQWhCO0FBQ0E7QUFDRCxPQXJCRDtBQXNCQTtBQUNELEtBMUJEO0FBMkJBOztBQUVEN0IsTUFBR2MsR0FBSCxHQUFTUCxrQkFBa0JKLFNBQVNXLEdBQTNCLEVBQWdDZCxHQUFHYyxHQUFuQyxDQUFUO0FBQ0FkLE1BQUdlLEdBQUgsR0FBU1Isa0JBQWtCSixTQUFTWSxHQUEzQixFQUFnQ2YsR0FBR2UsR0FBbkMsQ0FBVDs7QUFFQSxPQUFJZixHQUFHYyxHQUFILEtBQVdkLEdBQUdlLEdBQWxCLEVBQXVCO0FBQ3RCLFFBQUlmLEdBQUdjLEdBQUgsS0FBVyxDQUFYLElBQWdCZCxHQUFHYyxHQUFILEtBQVcsSUFBL0IsRUFBcUM7QUFDcENkLFFBQUdjLEdBQUgsR0FBU3VCLEtBQUtDLEdBQUwsQ0FBUyxFQUFULEVBQWFELEtBQUtFLEtBQUwsQ0FBV25ELFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHYyxHQUFqQixDQUFYLElBQW9DLENBQWpELENBQVQ7QUFDQWQsUUFBR2UsR0FBSCxHQUFTc0IsS0FBS0MsR0FBTCxDQUFTLEVBQVQsRUFBYUQsS0FBS0UsS0FBTCxDQUFXbkQsUUFBUW9ELEtBQVIsQ0FBY3hDLEdBQUdlLEdBQWpCLENBQVgsSUFBb0MsQ0FBakQsQ0FBVDtBQUNBLEtBSEQsTUFHTztBQUNOZixRQUFHYyxHQUFILEdBQVMsQ0FBVDtBQUNBZCxRQUFHZSxHQUFILEdBQVMsRUFBVDtBQUNBO0FBQ0Q7QUFDRCxHQWpHd0M7QUFrR3pDMEIsY0FBWSxzQkFBVztBQUN0QixPQUFJekMsS0FBSyxJQUFUO0FBQ0EsT0FBSUMsT0FBT0QsR0FBR0UsT0FBZDtBQUNBLE9BQUlDLFdBQVdGLEtBQUtWLEtBQXBCOztBQUVBLE9BQUltRCxvQkFBb0I7QUFDdkI1QixTQUFLWCxTQUFTVyxHQURTO0FBRXZCQyxTQUFLWixTQUFTWTtBQUZTLElBQXhCO0FBSUEsT0FBSXhCLFFBQVFTLEdBQUdULEtBQUgsR0FBV0osTUFBTU0sS0FBTixDQUFZa0QsVUFBWixDQUF1QmhELFdBQXZCLENBQW1DK0MsaUJBQW5DLEVBQXNEMUMsRUFBdEQsQ0FBdkI7O0FBRUEsT0FBSSxDQUFDQSxHQUFHUSxZQUFILEVBQUwsRUFBd0I7QUFDdkI7QUFDQWpCLFVBQU1xRCxPQUFOO0FBQ0E7O0FBRUQ7QUFDQTtBQUNBNUMsTUFBR2UsR0FBSCxHQUFTM0IsUUFBUTJCLEdBQVIsQ0FBWXhCLEtBQVosQ0FBVDtBQUNBUyxNQUFHYyxHQUFILEdBQVMxQixRQUFRMEIsR0FBUixDQUFZdkIsS0FBWixDQUFUOztBQUVBLE9BQUlZLFNBQVN5QyxPQUFiLEVBQXNCO0FBQ3JCckQsVUFBTXFELE9BQU47O0FBRUE1QyxPQUFHNkMsS0FBSCxHQUFXN0MsR0FBR2UsR0FBZDtBQUNBZixPQUFHOEMsR0FBSCxHQUFTOUMsR0FBR2MsR0FBWjtBQUNBLElBTEQsTUFLTztBQUNOZCxPQUFHNkMsS0FBSCxHQUFXN0MsR0FBR2MsR0FBZDtBQUNBZCxPQUFHOEMsR0FBSCxHQUFTOUMsR0FBR2UsR0FBWjtBQUNBO0FBQ0QsR0FoSXdDO0FBaUl6Q2dDLHdCQUFzQixnQ0FBVztBQUNoQyxRQUFLQyxVQUFMLEdBQWtCLEtBQUt6RCxLQUFMLENBQVcwRCxLQUFYLEVBQWxCOztBQUVBOUQsU0FBTVUsS0FBTixDQUFZcUQsU0FBWixDQUFzQkgsb0JBQXRCLENBQTJDSSxJQUEzQyxDQUFnRCxJQUFoRDtBQUNBLEdBckl3QztBQXNJekM7QUFDQUMsb0JBQWtCLDBCQUFTekIsS0FBVCxFQUFnQk4sWUFBaEIsRUFBOEI7QUFDL0MsVUFBTyxDQUFDLEtBQUtTLGFBQUwsQ0FBbUIsS0FBSzFCLEtBQUwsQ0FBV0MsSUFBWCxDQUFnQkMsUUFBaEIsQ0FBeUJlLFlBQXpCLEVBQXVDaEIsSUFBdkMsQ0FBNENzQixLQUE1QyxDQUFuQixDQUFSO0FBQ0EsR0F6SXdDO0FBMEl6QzBCLG1CQUFpQix5QkFBUzFCLEtBQVQsRUFBZ0I7QUFDaEMsVUFBTyxLQUFLMkIsZ0JBQUwsQ0FBc0IsS0FBS04sVUFBTCxDQUFnQnJCLEtBQWhCLENBQXRCLENBQVA7QUFDQSxHQTVJd0M7QUE2SXpDMkIsb0JBQWtCLDBCQUFTekIsS0FBVCxFQUFnQjtBQUNqQyxPQUFJN0IsS0FBSyxJQUFUO0FBQ0EsT0FBSXVELGNBQUo7QUFDQSxPQUFJQyxLQUFKOztBQUVBLE9BQUlYLFFBQVE3QyxHQUFHNkMsS0FBZjtBQUNBLE9BQUlZLFNBQVMsQ0FBQ3pELEdBQUc4QixhQUFILENBQWlCRCxLQUFqQixDQUFkO0FBQ0EsT0FBSTZCLEtBQUo7QUFDQSxPQUFJQyxhQUFhM0QsR0FBRzJELFVBQXBCO0FBQ0EsT0FBSUMsZ0JBQWdCNUQsR0FBRzRELGFBQXZCO0FBQ0EsT0FBSUMsY0FBYzdELEdBQUc2RCxXQUFyQjtBQUNBLE9BQUk1RCxPQUFPRCxHQUFHRSxPQUFkO0FBQ0EsT0FBSUMsV0FBV0YsS0FBS1YsS0FBcEI7O0FBRUEsT0FBSVMsR0FBR1EsWUFBSCxFQUFKLEVBQXVCO0FBQ3RCa0QsWUFBUXRFLFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHOEMsR0FBakIsSUFBd0IxRCxRQUFRb0QsS0FBUixDQUFjSyxLQUFkLENBQWhDLENBRHNCLENBQ2dDO0FBQ3RELFFBQUlZLFdBQVcsQ0FBZixFQUFrQjtBQUNqQkQsYUFBUXhELEdBQUc4RCxJQUFILEdBQVVELFdBQWxCO0FBQ0EsS0FGRCxNQUVPO0FBQ05OLHNCQUFpQnZELEdBQUcrRCxLQUFILElBQVlGLGNBQWM3RCxHQUFHZ0UsWUFBN0IsQ0FBakI7QUFDQVIsYUFBUXhELEdBQUc4RCxJQUFILEdBQVdQLGlCQUFpQkcsS0FBakIsSUFBMEJ0RSxRQUFRb0QsS0FBUixDQUFjaUIsTUFBZCxJQUF3QnJFLFFBQVFvRCxLQUFSLENBQWNLLEtBQWQsQ0FBbEQsQ0FBbkI7QUFDQVcsY0FBU0ssV0FBVDtBQUNBO0FBQ0QsSUFURCxNQVNPO0FBQ047QUFDQU4scUJBQWlCdkQsR0FBR2lFLE1BQUgsSUFBYU4sYUFBYUMsYUFBMUIsQ0FBakI7QUFDQSxRQUFJZixVQUFVLENBQVYsSUFBZSxDQUFDMUMsU0FBU3lDLE9BQTdCLEVBQXNDO0FBQ3JDYyxhQUFRdEUsUUFBUW9ELEtBQVIsQ0FBY3hDLEdBQUc4QyxHQUFqQixJQUF3QjFELFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHZ0IsVUFBakIsQ0FBaEM7QUFDQSxTQUFJeUMsV0FBV1osS0FBZixFQUFzQjtBQUNyQlcsY0FBUXhELEdBQUdrRSxNQUFILEdBQVlOLGFBQXBCO0FBQ0EsTUFGRCxNQUVPLElBQUlILFdBQVd6RCxHQUFHZ0IsVUFBbEIsRUFBOEI7QUFDcEN3QyxjQUFReEQsR0FBR2tFLE1BQUgsR0FBWU4sYUFBWixHQUE0QkwsaUJBQWlCLElBQXJEO0FBQ0EsTUFGTSxNQUVBO0FBQ05DLGNBQVF4RCxHQUFHa0UsTUFBSCxHQUFZTixhQUFaLEdBQTRCTCxpQkFBaUIsSUFBN0MsR0FBcURBLGlCQUFpQixJQUFqQixHQUF1QkcsS0FBdkIsSUFBZ0N0RSxRQUFRb0QsS0FBUixDQUFjaUIsTUFBZCxJQUFzQnJFLFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHZ0IsVUFBakIsQ0FBdEQsQ0FBN0Q7QUFDQTtBQUNELEtBVEQsTUFTTyxJQUFJaEIsR0FBRzhDLEdBQUgsS0FBVyxDQUFYLElBQWdCM0MsU0FBU3lDLE9BQTdCLEVBQXNDO0FBQzVDYyxhQUFRdEUsUUFBUW9ELEtBQVIsQ0FBY3hDLEdBQUc2QyxLQUFqQixJQUEwQnpELFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHZ0IsVUFBakIsQ0FBbEM7QUFDQSxTQUFJeUMsV0FBV3pELEdBQUc4QyxHQUFsQixFQUF1QjtBQUN0QlUsY0FBUXhELEdBQUdtRSxHQUFILEdBQVNSLFVBQWpCO0FBQ0EsTUFGRCxNQUVPLElBQUlGLFdBQVd6RCxHQUFHZ0IsVUFBbEIsRUFBOEI7QUFDcEN3QyxjQUFReEQsR0FBR21FLEdBQUgsR0FBU1IsVUFBVCxHQUFzQkosaUJBQWlCLElBQS9DO0FBQ0EsTUFGTSxNQUVBO0FBQ05DLGNBQVF4RCxHQUFHbUUsR0FBSCxHQUFTUixVQUFULEdBQXNCSixpQkFBaUIsSUFBdkMsR0FBK0NBLGlCQUFpQixJQUFqQixHQUF1QkcsS0FBdkIsSUFBZ0N0RSxRQUFRb0QsS0FBUixDQUFjaUIsTUFBZCxJQUFzQnJFLFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHZ0IsVUFBakIsQ0FBdEQsQ0FBdkQ7QUFDQTtBQUNELEtBVE0sTUFTQTtBQUNOMEMsYUFBUXRFLFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHOEMsR0FBakIsSUFBd0IxRCxRQUFRb0QsS0FBUixDQUFjSyxLQUFkLENBQWhDO0FBQ0FVLHNCQUFpQnZELEdBQUdpRSxNQUFILElBQWFOLGFBQWFDLGFBQTFCLENBQWpCO0FBQ0FKLGFBQVN4RCxHQUFHa0UsTUFBSCxHQUFZTixhQUFiLEdBQStCTCxpQkFBaUJHLEtBQWpCLElBQTBCdEUsUUFBUW9ELEtBQVIsQ0FBY2lCLE1BQWQsSUFBd0JyRSxRQUFRb0QsS0FBUixDQUFjSyxLQUFkLENBQWxELENBQXZDO0FBQ0E7QUFDRDtBQUNELFVBQU9XLEtBQVA7QUFDQSxHQWhNd0M7QUFpTXpDWSxvQkFBa0IsMEJBQVNaLEtBQVQsRUFBZ0I7QUFDakMsT0FBSXhELEtBQUssSUFBVDtBQUNBLE9BQUkwRCxRQUFRdEUsUUFBUW9ELEtBQVIsQ0FBY3hDLEdBQUc4QyxHQUFqQixJQUF3QjFELFFBQVFvRCxLQUFSLENBQWN4QyxHQUFHNkMsS0FBakIsQ0FBcEM7QUFDQSxPQUFJaEIsS0FBSixFQUFXMEIsY0FBWDs7QUFFQSxPQUFJdkQsR0FBR1EsWUFBSCxFQUFKLEVBQXVCO0FBQ3RCK0MscUJBQWlCdkQsR0FBRytELEtBQUgsSUFBWS9ELEdBQUc2RCxXQUFILEdBQWlCN0QsR0FBR2dFLFlBQWhDLENBQWpCO0FBQ0FuQyxZQUFRN0IsR0FBRzZDLEtBQUgsR0FBV1IsS0FBS0MsR0FBTCxDQUFTLEVBQVQsRUFBYSxDQUFDa0IsUUFBUXhELEdBQUc4RCxJQUFYLEdBQWtCOUQsR0FBRzZELFdBQXRCLElBQXFDSCxLQUFyQyxHQUE2Q0gsY0FBMUQsQ0FBbkI7QUFDQSxJQUhELE1BR087QUFBRztBQUNUQSxxQkFBaUJ2RCxHQUFHaUUsTUFBSCxJQUFhakUsR0FBRzJELFVBQUgsR0FBZ0IzRCxHQUFHNEQsYUFBaEMsQ0FBakI7QUFDQS9CLFlBQVFRLEtBQUtDLEdBQUwsQ0FBUyxFQUFULEVBQWEsQ0FBQ3RDLEdBQUdrRSxNQUFILEdBQVlsRSxHQUFHNEQsYUFBZixHQUErQkosS0FBaEMsSUFBeUNFLEtBQXpDLEdBQWlESCxjQUE5RCxJQUFnRnZELEdBQUc2QyxLQUEzRjtBQUNBO0FBQ0QsVUFBT2hCLEtBQVA7QUFDQTtBQTlNd0MsRUFBbkIsQ0FBdkI7QUFnTkExQyxPQUFNa0YsWUFBTixDQUFtQkMsaUJBQW5CLENBQXFDLGFBQXJDLEVBQW9EMUUsZ0JBQXBELEVBQXNFUCxhQUF0RTtBQUVBLENBL05EIiwiZmlsZSI6InNjYWxlLmxvZ2FyaXRobWljLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xyXG5cclxubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihDaGFydCkge1xyXG5cclxuXHR2YXIgaGVscGVycyA9IENoYXJ0LmhlbHBlcnM7XHJcblxyXG5cdHZhciBkZWZhdWx0Q29uZmlnID0ge1xyXG5cdFx0cG9zaXRpb246ICdsZWZ0JyxcclxuXHJcblx0XHQvLyBsYWJlbCBzZXR0aW5nc1xyXG5cdFx0dGlja3M6IHtcclxuXHRcdFx0Y2FsbGJhY2s6IENoYXJ0LlRpY2tzLmZvcm1hdHRlcnMubG9nYXJpdGhtaWNcclxuXHRcdH1cclxuXHR9O1xyXG5cclxuXHR2YXIgTG9nYXJpdGhtaWNTY2FsZSA9IENoYXJ0LlNjYWxlLmV4dGVuZCh7XHJcblx0XHRkZXRlcm1pbmVEYXRhTGltaXRzOiBmdW5jdGlvbigpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIG9wdHMgPSBtZS5vcHRpb25zO1xyXG5cdFx0XHR2YXIgdGlja09wdHMgPSBvcHRzLnRpY2tzO1xyXG5cdFx0XHR2YXIgY2hhcnQgPSBtZS5jaGFydDtcclxuXHRcdFx0dmFyIGRhdGEgPSBjaGFydC5kYXRhO1xyXG5cdFx0XHR2YXIgZGF0YXNldHMgPSBkYXRhLmRhdGFzZXRzO1xyXG5cdFx0XHR2YXIgZ2V0VmFsdWVPckRlZmF1bHQgPSBoZWxwZXJzLmdldFZhbHVlT3JEZWZhdWx0O1xyXG5cdFx0XHR2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7XHJcblx0XHRcdGZ1bmN0aW9uIElETWF0Y2hlcyhtZXRhKSB7XHJcblx0XHRcdFx0cmV0dXJuIGlzSG9yaXpvbnRhbCA/IG1ldGEueEF4aXNJRCA9PT0gbWUuaWQgOiBtZXRhLnlBeGlzSUQgPT09IG1lLmlkO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHQvLyBDYWxjdWxhdGUgUmFuZ2VcclxuXHRcdFx0bWUubWluID0gbnVsbDtcclxuXHRcdFx0bWUubWF4ID0gbnVsbDtcclxuXHRcdFx0bWUubWluTm90WmVybyA9IG51bGw7XHJcblxyXG5cdFx0XHRpZiAob3B0cy5zdGFja2VkKSB7XHJcblx0XHRcdFx0dmFyIHZhbHVlc1BlclR5cGUgPSB7fTtcclxuXHJcblx0XHRcdFx0aGVscGVycy5lYWNoKGRhdGFzZXRzLCBmdW5jdGlvbihkYXRhc2V0LCBkYXRhc2V0SW5kZXgpIHtcclxuXHRcdFx0XHRcdHZhciBtZXRhID0gY2hhcnQuZ2V0RGF0YXNldE1ldGEoZGF0YXNldEluZGV4KTtcclxuXHRcdFx0XHRcdGlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkgJiYgSURNYXRjaGVzKG1ldGEpKSB7XHJcblx0XHRcdFx0XHRcdGlmICh2YWx1ZXNQZXJUeXBlW21ldGEudHlwZV0gPT09IHVuZGVmaW5lZCkge1xyXG5cdFx0XHRcdFx0XHRcdHZhbHVlc1BlclR5cGVbbWV0YS50eXBlXSA9IFtdO1xyXG5cdFx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0XHRoZWxwZXJzLmVhY2goZGF0YXNldC5kYXRhLCBmdW5jdGlvbihyYXdWYWx1ZSwgaW5kZXgpIHtcclxuXHRcdFx0XHRcdFx0XHR2YXIgdmFsdWVzID0gdmFsdWVzUGVyVHlwZVttZXRhLnR5cGVdO1xyXG5cdFx0XHRcdFx0XHRcdHZhciB2YWx1ZSA9ICttZS5nZXRSaWdodFZhbHVlKHJhd1ZhbHVlKTtcclxuXHRcdFx0XHRcdFx0XHRpZiAoaXNOYU4odmFsdWUpIHx8IG1ldGEuZGF0YVtpbmRleF0uaGlkZGVuKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdFx0XHR2YWx1ZXNbaW5kZXhdID0gdmFsdWVzW2luZGV4XSB8fCAwO1xyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAob3B0cy5yZWxhdGl2ZVBvaW50cykge1xyXG5cdFx0XHRcdFx0XHRcdFx0dmFsdWVzW2luZGV4XSA9IDEwMDtcclxuXHRcdFx0XHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0XHRcdFx0Ly8gRG9uJ3QgbmVlZCB0byBzcGxpdCBwb3NpdGl2ZSBhbmQgbmVnYXRpdmUgc2luY2UgdGhlIGxvZyBzY2FsZSBjYW4ndCBoYW5kbGUgYSAwIGNyb3NzaW5nXHJcblx0XHRcdFx0XHRcdFx0XHR2YWx1ZXNbaW5kZXhdICs9IHZhbHVlO1xyXG5cdFx0XHRcdFx0XHRcdH1cclxuXHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHR9XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHRcdGhlbHBlcnMuZWFjaCh2YWx1ZXNQZXJUeXBlLCBmdW5jdGlvbih2YWx1ZXNGb3JUeXBlKSB7XHJcblx0XHRcdFx0XHR2YXIgbWluVmFsID0gaGVscGVycy5taW4odmFsdWVzRm9yVHlwZSk7XHJcblx0XHRcdFx0XHR2YXIgbWF4VmFsID0gaGVscGVycy5tYXgodmFsdWVzRm9yVHlwZSk7XHJcblx0XHRcdFx0XHRtZS5taW4gPSBtZS5taW4gPT09IG51bGwgPyBtaW5WYWwgOiBNYXRoLm1pbihtZS5taW4sIG1pblZhbCk7XHJcblx0XHRcdFx0XHRtZS5tYXggPSBtZS5tYXggPT09IG51bGwgPyBtYXhWYWwgOiBNYXRoLm1heChtZS5tYXgsIG1heFZhbCk7XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdGhlbHBlcnMuZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7XHJcblx0XHRcdFx0XHR2YXIgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7XHJcblx0XHRcdFx0XHRpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShkYXRhc2V0SW5kZXgpICYmIElETWF0Y2hlcyhtZXRhKSkge1xyXG5cdFx0XHRcdFx0XHRoZWxwZXJzLmVhY2goZGF0YXNldC5kYXRhLCBmdW5jdGlvbihyYXdWYWx1ZSwgaW5kZXgpIHtcclxuXHRcdFx0XHRcdFx0XHR2YXIgdmFsdWUgPSArbWUuZ2V0UmlnaHRWYWx1ZShyYXdWYWx1ZSk7XHJcblx0XHRcdFx0XHRcdFx0aWYgKGlzTmFOKHZhbHVlKSB8fCBtZXRhLmRhdGFbaW5kZXhdLmhpZGRlbikge1xyXG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHRcdFx0aWYgKG1lLm1pbiA9PT0gbnVsbCkge1xyXG5cdFx0XHRcdFx0XHRcdFx0bWUubWluID0gdmFsdWU7XHJcblx0XHRcdFx0XHRcdFx0fSBlbHNlIGlmICh2YWx1ZSA8IG1lLm1pbikge1xyXG5cdFx0XHRcdFx0XHRcdFx0bWUubWluID0gdmFsdWU7XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAobWUubWF4ID09PSBudWxsKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRtZS5tYXggPSB2YWx1ZTtcclxuXHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKHZhbHVlID4gbWUubWF4KSB7XHJcblx0XHRcdFx0XHRcdFx0XHRtZS5tYXggPSB2YWx1ZTtcclxuXHRcdFx0XHRcdFx0XHR9XHJcblxyXG5cdFx0XHRcdFx0XHRcdGlmICh2YWx1ZSAhPT0gMCAmJiAobWUubWluTm90WmVybyA9PT0gbnVsbCB8fCB2YWx1ZSA8IG1lLm1pbk5vdFplcm8pKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRtZS5taW5Ob3RaZXJvID0gdmFsdWU7XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0bWUubWluID0gZ2V0VmFsdWVPckRlZmF1bHQodGlja09wdHMubWluLCBtZS5taW4pO1xyXG5cdFx0XHRtZS5tYXggPSBnZXRWYWx1ZU9yRGVmYXVsdCh0aWNrT3B0cy5tYXgsIG1lLm1heCk7XHJcblxyXG5cdFx0XHRpZiAobWUubWluID09PSBtZS5tYXgpIHtcclxuXHRcdFx0XHRpZiAobWUubWluICE9PSAwICYmIG1lLm1pbiAhPT0gbnVsbCkge1xyXG5cdFx0XHRcdFx0bWUubWluID0gTWF0aC5wb3coMTAsIE1hdGguZmxvb3IoaGVscGVycy5sb2cxMChtZS5taW4pKSAtIDEpO1xyXG5cdFx0XHRcdFx0bWUubWF4ID0gTWF0aC5wb3coMTAsIE1hdGguZmxvb3IoaGVscGVycy5sb2cxMChtZS5tYXgpKSArIDEpO1xyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRtZS5taW4gPSAxO1xyXG5cdFx0XHRcdFx0bWUubWF4ID0gMTA7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cdFx0YnVpbGRUaWNrczogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHZhciBtZSA9IHRoaXM7XHJcblx0XHRcdHZhciBvcHRzID0gbWUub3B0aW9ucztcclxuXHRcdFx0dmFyIHRpY2tPcHRzID0gb3B0cy50aWNrcztcclxuXHJcblx0XHRcdHZhciBnZW5lcmF0aW9uT3B0aW9ucyA9IHtcclxuXHRcdFx0XHRtaW46IHRpY2tPcHRzLm1pbixcclxuXHRcdFx0XHRtYXg6IHRpY2tPcHRzLm1heFxyXG5cdFx0XHR9O1xyXG5cdFx0XHR2YXIgdGlja3MgPSBtZS50aWNrcyA9IENoYXJ0LlRpY2tzLmdlbmVyYXRvcnMubG9nYXJpdGhtaWMoZ2VuZXJhdGlvbk9wdGlvbnMsIG1lKTtcclxuXHJcblx0XHRcdGlmICghbWUuaXNIb3Jpem9udGFsKCkpIHtcclxuXHRcdFx0XHQvLyBXZSBhcmUgaW4gYSB2ZXJ0aWNhbCBvcmllbnRhdGlvbi4gVGhlIHRvcCB2YWx1ZSBpcyB0aGUgaGlnaGVzdC4gU28gcmV2ZXJzZSB0aGUgYXJyYXlcclxuXHRcdFx0XHR0aWNrcy5yZXZlcnNlKCk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdC8vIEF0IHRoaXMgcG9pbnQsIHdlIG5lZWQgdG8gdXBkYXRlIG91ciBtYXggYW5kIG1pbiBnaXZlbiB0aGUgdGljayB2YWx1ZXMgc2luY2Ugd2UgaGF2ZSBleHBhbmRlZCB0aGVcclxuXHRcdFx0Ly8gcmFuZ2Ugb2YgdGhlIHNjYWxlXHJcblx0XHRcdG1lLm1heCA9IGhlbHBlcnMubWF4KHRpY2tzKTtcclxuXHRcdFx0bWUubWluID0gaGVscGVycy5taW4odGlja3MpO1xyXG5cclxuXHRcdFx0aWYgKHRpY2tPcHRzLnJldmVyc2UpIHtcclxuXHRcdFx0XHR0aWNrcy5yZXZlcnNlKCk7XHJcblxyXG5cdFx0XHRcdG1lLnN0YXJ0ID0gbWUubWF4O1xyXG5cdFx0XHRcdG1lLmVuZCA9IG1lLm1pbjtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRtZS5zdGFydCA9IG1lLm1pbjtcclxuXHRcdFx0XHRtZS5lbmQgPSBtZS5tYXg7XHJcblx0XHRcdH1cclxuXHRcdH0sXHJcblx0XHRjb252ZXJ0VGlja3NUb0xhYmVsczogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHRoaXMudGlja1ZhbHVlcyA9IHRoaXMudGlja3Muc2xpY2UoKTtcclxuXHJcblx0XHRcdENoYXJ0LlNjYWxlLnByb3RvdHlwZS5jb252ZXJ0VGlja3NUb0xhYmVscy5jYWxsKHRoaXMpO1xyXG5cdFx0fSxcclxuXHRcdC8vIEdldCB0aGUgY29ycmVjdCB0b29sdGlwIGxhYmVsXHJcblx0XHRnZXRMYWJlbEZvckluZGV4OiBmdW5jdGlvbihpbmRleCwgZGF0YXNldEluZGV4KSB7XHJcblx0XHRcdHJldHVybiArdGhpcy5nZXRSaWdodFZhbHVlKHRoaXMuY2hhcnQuZGF0YS5kYXRhc2V0c1tkYXRhc2V0SW5kZXhdLmRhdGFbaW5kZXhdKTtcclxuXHRcdH0sXHJcblx0XHRnZXRQaXhlbEZvclRpY2s6IGZ1bmN0aW9uKGluZGV4KSB7XHJcblx0XHRcdHJldHVybiB0aGlzLmdldFBpeGVsRm9yVmFsdWUodGhpcy50aWNrVmFsdWVzW2luZGV4XSk7XHJcblx0XHR9LFxyXG5cdFx0Z2V0UGl4ZWxGb3JWYWx1ZTogZnVuY3Rpb24odmFsdWUpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIGlubmVyRGltZW5zaW9uO1xyXG5cdFx0XHR2YXIgcGl4ZWw7XHJcblxyXG5cdFx0XHR2YXIgc3RhcnQgPSBtZS5zdGFydDtcclxuXHRcdFx0dmFyIG5ld1ZhbCA9ICttZS5nZXRSaWdodFZhbHVlKHZhbHVlKTtcclxuXHRcdFx0dmFyIHJhbmdlO1xyXG5cdFx0XHR2YXIgcGFkZGluZ1RvcCA9IG1lLnBhZGRpbmdUb3A7XHJcblx0XHRcdHZhciBwYWRkaW5nQm90dG9tID0gbWUucGFkZGluZ0JvdHRvbTtcclxuXHRcdFx0dmFyIHBhZGRpbmdMZWZ0ID0gbWUucGFkZGluZ0xlZnQ7XHJcblx0XHRcdHZhciBvcHRzID0gbWUub3B0aW9ucztcclxuXHRcdFx0dmFyIHRpY2tPcHRzID0gb3B0cy50aWNrcztcclxuXHJcblx0XHRcdGlmIChtZS5pc0hvcml6b250YWwoKSkge1xyXG5cdFx0XHRcdHJhbmdlID0gaGVscGVycy5sb2cxMChtZS5lbmQpIC0gaGVscGVycy5sb2cxMChzdGFydCk7IC8vIHRvZG86IGlmIHN0YXJ0ID09PSAwXHJcblx0XHRcdFx0aWYgKG5ld1ZhbCA9PT0gMCkge1xyXG5cdFx0XHRcdFx0cGl4ZWwgPSBtZS5sZWZ0ICsgcGFkZGluZ0xlZnQ7XHJcblx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdGlubmVyRGltZW5zaW9uID0gbWUud2lkdGggLSAocGFkZGluZ0xlZnQgKyBtZS5wYWRkaW5nUmlnaHQpO1xyXG5cdFx0XHRcdFx0cGl4ZWwgPSBtZS5sZWZ0ICsgKGlubmVyRGltZW5zaW9uIC8gcmFuZ2UgKiAoaGVscGVycy5sb2cxMChuZXdWYWwpIC0gaGVscGVycy5sb2cxMChzdGFydCkpKTtcclxuXHRcdFx0XHRcdHBpeGVsICs9IHBhZGRpbmdMZWZ0O1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHQvLyBCb3R0b20gLSB0b3Agc2luY2UgcGl4ZWxzIGluY3JlYXNlIGRvd253YXJkIG9uIGEgc2NyZWVuXHJcblx0XHRcdFx0aW5uZXJEaW1lbnNpb24gPSBtZS5oZWlnaHQgLSAocGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b20pO1xyXG5cdFx0XHRcdGlmIChzdGFydCA9PT0gMCAmJiAhdGlja09wdHMucmV2ZXJzZSkge1xyXG5cdFx0XHRcdFx0cmFuZ2UgPSBoZWxwZXJzLmxvZzEwKG1lLmVuZCkgLSBoZWxwZXJzLmxvZzEwKG1lLm1pbk5vdFplcm8pO1xyXG5cdFx0XHRcdFx0aWYgKG5ld1ZhbCA9PT0gc3RhcnQpIHtcclxuXHRcdFx0XHRcdFx0cGl4ZWwgPSBtZS5ib3R0b20gLSBwYWRkaW5nQm90dG9tO1xyXG5cdFx0XHRcdFx0fSBlbHNlIGlmIChuZXdWYWwgPT09IG1lLm1pbk5vdFplcm8pIHtcclxuXHRcdFx0XHRcdFx0cGl4ZWwgPSBtZS5ib3R0b20gLSBwYWRkaW5nQm90dG9tIC0gaW5uZXJEaW1lbnNpb24gKiAwLjAyO1xyXG5cdFx0XHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRcdFx0cGl4ZWwgPSBtZS5ib3R0b20gLSBwYWRkaW5nQm90dG9tIC0gaW5uZXJEaW1lbnNpb24gKiAwLjAyIC0gKGlubmVyRGltZW5zaW9uICogMC45OC8gcmFuZ2UgKiAoaGVscGVycy5sb2cxMChuZXdWYWwpLWhlbHBlcnMubG9nMTAobWUubWluTm90WmVybykpKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9IGVsc2UgaWYgKG1lLmVuZCA9PT0gMCAmJiB0aWNrT3B0cy5yZXZlcnNlKSB7XHJcblx0XHRcdFx0XHRyYW5nZSA9IGhlbHBlcnMubG9nMTAobWUuc3RhcnQpIC0gaGVscGVycy5sb2cxMChtZS5taW5Ob3RaZXJvKTtcclxuXHRcdFx0XHRcdGlmIChuZXdWYWwgPT09IG1lLmVuZCkge1xyXG5cdFx0XHRcdFx0XHRwaXhlbCA9IG1lLnRvcCArIHBhZGRpbmdUb3A7XHJcblx0XHRcdFx0XHR9IGVsc2UgaWYgKG5ld1ZhbCA9PT0gbWUubWluTm90WmVybykge1xyXG5cdFx0XHRcdFx0XHRwaXhlbCA9IG1lLnRvcCArIHBhZGRpbmdUb3AgKyBpbm5lckRpbWVuc2lvbiAqIDAuMDI7XHJcblx0XHRcdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdFx0XHRwaXhlbCA9IG1lLnRvcCArIHBhZGRpbmdUb3AgKyBpbm5lckRpbWVuc2lvbiAqIDAuMDIgKyAoaW5uZXJEaW1lbnNpb24gKiAwLjk4LyByYW5nZSAqIChoZWxwZXJzLmxvZzEwKG5ld1ZhbCktaGVscGVycy5sb2cxMChtZS5taW5Ob3RaZXJvKSkpO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRyYW5nZSA9IGhlbHBlcnMubG9nMTAobWUuZW5kKSAtIGhlbHBlcnMubG9nMTAoc3RhcnQpO1xyXG5cdFx0XHRcdFx0aW5uZXJEaW1lbnNpb24gPSBtZS5oZWlnaHQgLSAocGFkZGluZ1RvcCArIHBhZGRpbmdCb3R0b20pO1xyXG5cdFx0XHRcdFx0cGl4ZWwgPSAobWUuYm90dG9tIC0gcGFkZGluZ0JvdHRvbSkgLSAoaW5uZXJEaW1lbnNpb24gLyByYW5nZSAqIChoZWxwZXJzLmxvZzEwKG5ld1ZhbCkgLSBoZWxwZXJzLmxvZzEwKHN0YXJ0KSkpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fVxyXG5cdFx0XHRyZXR1cm4gcGl4ZWw7XHJcblx0XHR9LFxyXG5cdFx0Z2V0VmFsdWVGb3JQaXhlbDogZnVuY3Rpb24ocGl4ZWwpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIHJhbmdlID0gaGVscGVycy5sb2cxMChtZS5lbmQpIC0gaGVscGVycy5sb2cxMChtZS5zdGFydCk7XHJcblx0XHRcdHZhciB2YWx1ZSwgaW5uZXJEaW1lbnNpb247XHJcblxyXG5cdFx0XHRpZiAobWUuaXNIb3Jpem9udGFsKCkpIHtcclxuXHRcdFx0XHRpbm5lckRpbWVuc2lvbiA9IG1lLndpZHRoIC0gKG1lLnBhZGRpbmdMZWZ0ICsgbWUucGFkZGluZ1JpZ2h0KTtcclxuXHRcdFx0XHR2YWx1ZSA9IG1lLnN0YXJ0ICogTWF0aC5wb3coMTAsIChwaXhlbCAtIG1lLmxlZnQgLSBtZS5wYWRkaW5nTGVmdCkgKiByYW5nZSAvIGlubmVyRGltZW5zaW9uKTtcclxuXHRcdFx0fSBlbHNlIHsgIC8vIHRvZG86IGlmIHN0YXJ0ID09PSAwXHJcblx0XHRcdFx0aW5uZXJEaW1lbnNpb24gPSBtZS5oZWlnaHQgLSAobWUucGFkZGluZ1RvcCArIG1lLnBhZGRpbmdCb3R0b20pO1xyXG5cdFx0XHRcdHZhbHVlID0gTWF0aC5wb3coMTAsIChtZS5ib3R0b20gLSBtZS5wYWRkaW5nQm90dG9tIC0gcGl4ZWwpICogcmFuZ2UgLyBpbm5lckRpbWVuc2lvbikgLyBtZS5zdGFydDtcclxuXHRcdFx0fVxyXG5cdFx0XHRyZXR1cm4gdmFsdWU7XHJcblx0XHR9XHJcblx0fSk7XHJcblx0Q2hhcnQuc2NhbGVTZXJ2aWNlLnJlZ2lzdGVyU2NhbGVUeXBlKCdsb2dhcml0aG1pYycsIExvZ2FyaXRobWljU2NhbGUsIGRlZmF1bHRDb25maWcpO1xyXG5cclxufTtcclxuIl19
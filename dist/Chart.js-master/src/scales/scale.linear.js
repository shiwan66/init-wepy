'use strict';

module.exports = function (Chart) {

	var helpers = Chart.helpers;

	var defaultConfig = {
		position: 'left',
		ticks: {
			callback: Chart.Ticks.formatters.linear
		}
	};

	var LinearScale = Chart.LinearScaleBase.extend({
		determineDataLimits: function determineDataLimits() {
			var me = this;
			var opts = me.options;
			var chart = me.chart;
			var data = chart.data;
			var datasets = data.datasets;
			var isHorizontal = me.isHorizontal();

			function IDMatches(meta) {
				return isHorizontal ? meta.xAxisID === me.id : meta.yAxisID === me.id;
			}

			// First Calculate the range
			me.min = null;
			me.max = null;

			if (opts.stacked) {
				var valuesPerType = {};

				helpers.each(datasets, function (dataset, datasetIndex) {
					var meta = chart.getDatasetMeta(datasetIndex);
					if (valuesPerType[meta.type] === undefined) {
						valuesPerType[meta.type] = {
							positiveValues: [],
							negativeValues: []
						};
					}

					// Store these per type
					var positiveValues = valuesPerType[meta.type].positiveValues;
					var negativeValues = valuesPerType[meta.type].negativeValues;

					if (chart.isDatasetVisible(datasetIndex) && IDMatches(meta)) {
						helpers.each(dataset.data, function (rawValue, index) {
							var value = +me.getRightValue(rawValue);
							if (isNaN(value) || meta.data[index].hidden) {
								return;
							}

							positiveValues[index] = positiveValues[index] || 0;
							negativeValues[index] = negativeValues[index] || 0;

							if (opts.relativePoints) {
								positiveValues[index] = 100;
							} else if (value < 0) {
								negativeValues[index] += value;
							} else {
								positiveValues[index] += value;
							}
						});
					}
				});

				helpers.each(valuesPerType, function (valuesForType) {
					var values = valuesForType.positiveValues.concat(valuesForType.negativeValues);
					var minVal = helpers.min(values);
					var maxVal = helpers.max(values);
					me.min = me.min === null ? minVal : Math.min(me.min, minVal);
					me.max = me.max === null ? maxVal : Math.max(me.max, maxVal);
				});
			} else {
				helpers.each(datasets, function (dataset, datasetIndex) {
					var meta = chart.getDatasetMeta(datasetIndex);
					if (chart.isDatasetVisible(datasetIndex) && IDMatches(meta)) {
						helpers.each(dataset.data, function (rawValue, index) {
							var value = +me.getRightValue(rawValue);
							if (isNaN(value) || meta.data[index].hidden) {
								return;
							}

							if (me.min === null) {
								me.min = value;
							} else if (value < me.min) {
								me.min = value;
							}

							if (me.max === null) {
								me.max = value;
							} else if (value > me.max) {
								me.max = value;
							}
						});
					}
				});
			}

			// Common base implementation to handle ticks.min, ticks.max, ticks.beginAtZero
			this.handleTickRangeOptions();
		},
		getTickLimit: function getTickLimit() {
			var maxTicks;
			var me = this;
			var tickOpts = me.options.ticks;

			if (me.isHorizontal()) {
				maxTicks = Math.min(tickOpts.maxTicksLimit ? tickOpts.maxTicksLimit : 11, Math.ceil(me.width / 50));
			} else {
				// The factor of 2 used to scale the font size has been experimentally determined.
				var tickFontSize = helpers.getValueOrDefault(tickOpts.fontSize, Chart.defaults.global.defaultFontSize);
				maxTicks = Math.min(tickOpts.maxTicksLimit ? tickOpts.maxTicksLimit : 11, Math.ceil(me.height / (2 * tickFontSize)));
			}

			return maxTicks;
		},
		// Called after the ticks are built. We need
		handleDirectionalChanges: function handleDirectionalChanges() {
			if (!this.isHorizontal()) {
				// We are in a vertical orientation. The top value is the highest. So reverse the array
				this.ticks.reverse();
			}
		},
		getLabelForIndex: function getLabelForIndex(index, datasetIndex) {
			return +this.getRightValue(this.chart.data.datasets[datasetIndex].data[index]);
		},
		// Utils
		getPixelForValue: function getPixelForValue(value) {
			// This must be called after fit has been run so that
			// this.left, this.top, this.right, and this.bottom have been defined
			var me = this;
			var paddingLeft = me.paddingLeft;
			var paddingBottom = me.paddingBottom;
			var start = me.start;

			var rightValue = +me.getRightValue(value);
			var pixel;
			var innerDimension;
			var range = me.end - start;

			if (me.isHorizontal()) {
				innerDimension = me.width - (paddingLeft + me.paddingRight);
				pixel = me.left + innerDimension / range * (rightValue - start);
				return Math.round(pixel + paddingLeft);
			}
			innerDimension = me.height - (me.paddingTop + paddingBottom);
			pixel = me.bottom - paddingBottom - innerDimension / range * (rightValue - start);
			return Math.round(pixel);
		},
		getValueForPixel: function getValueForPixel(pixel) {
			var me = this;
			var isHorizontal = me.isHorizontal();
			var paddingLeft = me.paddingLeft;
			var paddingBottom = me.paddingBottom;
			var innerDimension = isHorizontal ? me.width - (paddingLeft + me.paddingRight) : me.height - (me.paddingTop + paddingBottom);
			var offset = (isHorizontal ? pixel - me.left - paddingLeft : me.bottom - paddingBottom - pixel) / innerDimension;
			return me.start + (me.end - me.start) * offset;
		},
		getPixelForTick: function getPixelForTick(index) {
			return this.getPixelForValue(this.ticksAsNumbers[index]);
		}
	});
	Chart.scaleService.registerScaleType('linear', LinearScale, defaultConfig);
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNjYWxlLmxpbmVhci5qcyJdLCJuYW1lcyI6WyJtb2R1bGUiLCJleHBvcnRzIiwiQ2hhcnQiLCJoZWxwZXJzIiwiZGVmYXVsdENvbmZpZyIsInBvc2l0aW9uIiwidGlja3MiLCJjYWxsYmFjayIsIlRpY2tzIiwiZm9ybWF0dGVycyIsImxpbmVhciIsIkxpbmVhclNjYWxlIiwiTGluZWFyU2NhbGVCYXNlIiwiZXh0ZW5kIiwiZGV0ZXJtaW5lRGF0YUxpbWl0cyIsIm1lIiwib3B0cyIsIm9wdGlvbnMiLCJjaGFydCIsImRhdGEiLCJkYXRhc2V0cyIsImlzSG9yaXpvbnRhbCIsIklETWF0Y2hlcyIsIm1ldGEiLCJ4QXhpc0lEIiwiaWQiLCJ5QXhpc0lEIiwibWluIiwibWF4Iiwic3RhY2tlZCIsInZhbHVlc1BlclR5cGUiLCJlYWNoIiwiZGF0YXNldCIsImRhdGFzZXRJbmRleCIsImdldERhdGFzZXRNZXRhIiwidHlwZSIsInVuZGVmaW5lZCIsInBvc2l0aXZlVmFsdWVzIiwibmVnYXRpdmVWYWx1ZXMiLCJpc0RhdGFzZXRWaXNpYmxlIiwicmF3VmFsdWUiLCJpbmRleCIsInZhbHVlIiwiZ2V0UmlnaHRWYWx1ZSIsImlzTmFOIiwiaGlkZGVuIiwicmVsYXRpdmVQb2ludHMiLCJ2YWx1ZXNGb3JUeXBlIiwidmFsdWVzIiwiY29uY2F0IiwibWluVmFsIiwibWF4VmFsIiwiTWF0aCIsImhhbmRsZVRpY2tSYW5nZU9wdGlvbnMiLCJnZXRUaWNrTGltaXQiLCJtYXhUaWNrcyIsInRpY2tPcHRzIiwibWF4VGlja3NMaW1pdCIsImNlaWwiLCJ3aWR0aCIsInRpY2tGb250U2l6ZSIsImdldFZhbHVlT3JEZWZhdWx0IiwiZm9udFNpemUiLCJkZWZhdWx0cyIsImdsb2JhbCIsImRlZmF1bHRGb250U2l6ZSIsImhlaWdodCIsImhhbmRsZURpcmVjdGlvbmFsQ2hhbmdlcyIsInJldmVyc2UiLCJnZXRMYWJlbEZvckluZGV4IiwiZ2V0UGl4ZWxGb3JWYWx1ZSIsInBhZGRpbmdMZWZ0IiwicGFkZGluZ0JvdHRvbSIsInN0YXJ0IiwicmlnaHRWYWx1ZSIsInBpeGVsIiwiaW5uZXJEaW1lbnNpb24iLCJyYW5nZSIsImVuZCIsInBhZGRpbmdSaWdodCIsImxlZnQiLCJyb3VuZCIsInBhZGRpbmdUb3AiLCJib3R0b20iLCJnZXRWYWx1ZUZvclBpeGVsIiwib2Zmc2V0IiwiZ2V0UGl4ZWxGb3JUaWNrIiwidGlja3NBc051bWJlcnMiLCJzY2FsZVNlcnZpY2UiLCJyZWdpc3RlclNjYWxlVHlwZSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE9BQU9DLE9BQVAsR0FBaUIsVUFBU0MsS0FBVCxFQUFnQjs7QUFFaEMsS0FBSUMsVUFBVUQsTUFBTUMsT0FBcEI7O0FBRUEsS0FBSUMsZ0JBQWdCO0FBQ25CQyxZQUFVLE1BRFM7QUFFbkJDLFNBQU87QUFDTkMsYUFBVUwsTUFBTU0sS0FBTixDQUFZQyxVQUFaLENBQXVCQztBQUQzQjtBQUZZLEVBQXBCOztBQU9BLEtBQUlDLGNBQWNULE1BQU1VLGVBQU4sQ0FBc0JDLE1BQXRCLENBQTZCO0FBQzlDQyx1QkFBcUIsK0JBQVc7QUFDL0IsT0FBSUMsS0FBSyxJQUFUO0FBQ0EsT0FBSUMsT0FBT0QsR0FBR0UsT0FBZDtBQUNBLE9BQUlDLFFBQVFILEdBQUdHLEtBQWY7QUFDQSxPQUFJQyxPQUFPRCxNQUFNQyxJQUFqQjtBQUNBLE9BQUlDLFdBQVdELEtBQUtDLFFBQXBCO0FBQ0EsT0FBSUMsZUFBZU4sR0FBR00sWUFBSCxFQUFuQjs7QUFFQSxZQUFTQyxTQUFULENBQW1CQyxJQUFuQixFQUF5QjtBQUN4QixXQUFPRixlQUFlRSxLQUFLQyxPQUFMLEtBQWlCVCxHQUFHVSxFQUFuQyxHQUF3Q0YsS0FBS0csT0FBTCxLQUFpQlgsR0FBR1UsRUFBbkU7QUFDQTs7QUFFRDtBQUNBVixNQUFHWSxHQUFILEdBQVMsSUFBVDtBQUNBWixNQUFHYSxHQUFILEdBQVMsSUFBVDs7QUFFQSxPQUFJWixLQUFLYSxPQUFULEVBQWtCO0FBQ2pCLFFBQUlDLGdCQUFnQixFQUFwQjs7QUFFQTNCLFlBQVE0QixJQUFSLENBQWFYLFFBQWIsRUFBdUIsVUFBU1ksT0FBVCxFQUFrQkMsWUFBbEIsRUFBZ0M7QUFDdEQsU0FBSVYsT0FBT0wsTUFBTWdCLGNBQU4sQ0FBcUJELFlBQXJCLENBQVg7QUFDQSxTQUFJSCxjQUFjUCxLQUFLWSxJQUFuQixNQUE2QkMsU0FBakMsRUFBNEM7QUFDM0NOLG9CQUFjUCxLQUFLWSxJQUFuQixJQUEyQjtBQUMxQkUsdUJBQWdCLEVBRFU7QUFFMUJDLHVCQUFnQjtBQUZVLE9BQTNCO0FBSUE7O0FBRUQ7QUFDQSxTQUFJRCxpQkFBaUJQLGNBQWNQLEtBQUtZLElBQW5CLEVBQXlCRSxjQUE5QztBQUNBLFNBQUlDLGlCQUFpQlIsY0FBY1AsS0FBS1ksSUFBbkIsRUFBeUJHLGNBQTlDOztBQUVBLFNBQUlwQixNQUFNcUIsZ0JBQU4sQ0FBdUJOLFlBQXZCLEtBQXdDWCxVQUFVQyxJQUFWLENBQTVDLEVBQTZEO0FBQzVEcEIsY0FBUTRCLElBQVIsQ0FBYUMsUUFBUWIsSUFBckIsRUFBMkIsVUFBU3FCLFFBQVQsRUFBbUJDLEtBQW5CLEVBQTBCO0FBQ3BELFdBQUlDLFFBQVEsQ0FBQzNCLEdBQUc0QixhQUFILENBQWlCSCxRQUFqQixDQUFiO0FBQ0EsV0FBSUksTUFBTUYsS0FBTixLQUFnQm5CLEtBQUtKLElBQUwsQ0FBVXNCLEtBQVYsRUFBaUJJLE1BQXJDLEVBQTZDO0FBQzVDO0FBQ0E7O0FBRURSLHNCQUFlSSxLQUFmLElBQXdCSixlQUFlSSxLQUFmLEtBQXlCLENBQWpEO0FBQ0FILHNCQUFlRyxLQUFmLElBQXdCSCxlQUFlRyxLQUFmLEtBQXlCLENBQWpEOztBQUVBLFdBQUl6QixLQUFLOEIsY0FBVCxFQUF5QjtBQUN4QlQsdUJBQWVJLEtBQWYsSUFBd0IsR0FBeEI7QUFDQSxRQUZELE1BRU8sSUFBSUMsUUFBUSxDQUFaLEVBQWU7QUFDckJKLHVCQUFlRyxLQUFmLEtBQXlCQyxLQUF6QjtBQUNBLFFBRk0sTUFFQTtBQUNOTCx1QkFBZUksS0FBZixLQUF5QkMsS0FBekI7QUFDQTtBQUNELE9BaEJEO0FBaUJBO0FBQ0QsS0FoQ0Q7O0FBa0NBdkMsWUFBUTRCLElBQVIsQ0FBYUQsYUFBYixFQUE0QixVQUFTaUIsYUFBVCxFQUF3QjtBQUNuRCxTQUFJQyxTQUFTRCxjQUFjVixjQUFkLENBQTZCWSxNQUE3QixDQUFvQ0YsY0FBY1QsY0FBbEQsQ0FBYjtBQUNBLFNBQUlZLFNBQVMvQyxRQUFRd0IsR0FBUixDQUFZcUIsTUFBWixDQUFiO0FBQ0EsU0FBSUcsU0FBU2hELFFBQVF5QixHQUFSLENBQVlvQixNQUFaLENBQWI7QUFDQWpDLFFBQUdZLEdBQUgsR0FBU1osR0FBR1ksR0FBSCxLQUFXLElBQVgsR0FBa0J1QixNQUFsQixHQUEyQkUsS0FBS3pCLEdBQUwsQ0FBU1osR0FBR1ksR0FBWixFQUFpQnVCLE1BQWpCLENBQXBDO0FBQ0FuQyxRQUFHYSxHQUFILEdBQVNiLEdBQUdhLEdBQUgsS0FBVyxJQUFYLEdBQWtCdUIsTUFBbEIsR0FBMkJDLEtBQUt4QixHQUFMLENBQVNiLEdBQUdhLEdBQVosRUFBaUJ1QixNQUFqQixDQUFwQztBQUNBLEtBTkQ7QUFRQSxJQTdDRCxNQTZDTztBQUNOaEQsWUFBUTRCLElBQVIsQ0FBYVgsUUFBYixFQUF1QixVQUFTWSxPQUFULEVBQWtCQyxZQUFsQixFQUFnQztBQUN0RCxTQUFJVixPQUFPTCxNQUFNZ0IsY0FBTixDQUFxQkQsWUFBckIsQ0FBWDtBQUNBLFNBQUlmLE1BQU1xQixnQkFBTixDQUF1Qk4sWUFBdkIsS0FBd0NYLFVBQVVDLElBQVYsQ0FBNUMsRUFBNkQ7QUFDNURwQixjQUFRNEIsSUFBUixDQUFhQyxRQUFRYixJQUFyQixFQUEyQixVQUFTcUIsUUFBVCxFQUFtQkMsS0FBbkIsRUFBMEI7QUFDcEQsV0FBSUMsUUFBUSxDQUFDM0IsR0FBRzRCLGFBQUgsQ0FBaUJILFFBQWpCLENBQWI7QUFDQSxXQUFJSSxNQUFNRixLQUFOLEtBQWdCbkIsS0FBS0osSUFBTCxDQUFVc0IsS0FBVixFQUFpQkksTUFBckMsRUFBNkM7QUFDNUM7QUFDQTs7QUFFRCxXQUFJOUIsR0FBR1ksR0FBSCxLQUFXLElBQWYsRUFBcUI7QUFDcEJaLFdBQUdZLEdBQUgsR0FBU2UsS0FBVDtBQUNBLFFBRkQsTUFFTyxJQUFJQSxRQUFRM0IsR0FBR1ksR0FBZixFQUFvQjtBQUMxQlosV0FBR1ksR0FBSCxHQUFTZSxLQUFUO0FBQ0E7O0FBRUQsV0FBSTNCLEdBQUdhLEdBQUgsS0FBVyxJQUFmLEVBQXFCO0FBQ3BCYixXQUFHYSxHQUFILEdBQVNjLEtBQVQ7QUFDQSxRQUZELE1BRU8sSUFBSUEsUUFBUTNCLEdBQUdhLEdBQWYsRUFBb0I7QUFDMUJiLFdBQUdhLEdBQUgsR0FBU2MsS0FBVDtBQUNBO0FBQ0QsT0FqQkQ7QUFrQkE7QUFDRCxLQXRCRDtBQXVCQTs7QUFFRDtBQUNBLFFBQUtXLHNCQUFMO0FBQ0EsR0ExRjZDO0FBMkY5Q0MsZ0JBQWMsd0JBQVc7QUFDeEIsT0FBSUMsUUFBSjtBQUNBLE9BQUl4QyxLQUFLLElBQVQ7QUFDQSxPQUFJeUMsV0FBV3pDLEdBQUdFLE9BQUgsQ0FBV1gsS0FBMUI7O0FBRUEsT0FBSVMsR0FBR00sWUFBSCxFQUFKLEVBQXVCO0FBQ3RCa0MsZUFBV0gsS0FBS3pCLEdBQUwsQ0FBUzZCLFNBQVNDLGFBQVQsR0FBeUJELFNBQVNDLGFBQWxDLEdBQWtELEVBQTNELEVBQStETCxLQUFLTSxJQUFMLENBQVUzQyxHQUFHNEMsS0FBSCxHQUFXLEVBQXJCLENBQS9ELENBQVg7QUFDQSxJQUZELE1BRU87QUFDTjtBQUNBLFFBQUlDLGVBQWV6RCxRQUFRMEQsaUJBQVIsQ0FBMEJMLFNBQVNNLFFBQW5DLEVBQTZDNUQsTUFBTTZELFFBQU4sQ0FBZUMsTUFBZixDQUFzQkMsZUFBbkUsQ0FBbkI7QUFDQVYsZUFBV0gsS0FBS3pCLEdBQUwsQ0FBUzZCLFNBQVNDLGFBQVQsR0FBeUJELFNBQVNDLGFBQWxDLEdBQWtELEVBQTNELEVBQStETCxLQUFLTSxJQUFMLENBQVUzQyxHQUFHbUQsTUFBSCxJQUFhLElBQUlOLFlBQWpCLENBQVYsQ0FBL0QsQ0FBWDtBQUNBOztBQUVELFVBQU9MLFFBQVA7QUFDQSxHQXpHNkM7QUEwRzlDO0FBQ0FZLDRCQUEwQixvQ0FBVztBQUNwQyxPQUFJLENBQUMsS0FBSzlDLFlBQUwsRUFBTCxFQUEwQjtBQUN6QjtBQUNBLFNBQUtmLEtBQUwsQ0FBVzhELE9BQVg7QUFDQTtBQUNELEdBaEg2QztBQWlIOUNDLG9CQUFrQiwwQkFBUzVCLEtBQVQsRUFBZ0JSLFlBQWhCLEVBQThCO0FBQy9DLFVBQU8sQ0FBQyxLQUFLVSxhQUFMLENBQW1CLEtBQUt6QixLQUFMLENBQVdDLElBQVgsQ0FBZ0JDLFFBQWhCLENBQXlCYSxZQUF6QixFQUF1Q2QsSUFBdkMsQ0FBNENzQixLQUE1QyxDQUFuQixDQUFSO0FBQ0EsR0FuSDZDO0FBb0g5QztBQUNBNkIsb0JBQWtCLDBCQUFTNUIsS0FBVCxFQUFnQjtBQUNqQztBQUNBO0FBQ0EsT0FBSTNCLEtBQUssSUFBVDtBQUNBLE9BQUl3RCxjQUFjeEQsR0FBR3dELFdBQXJCO0FBQ0EsT0FBSUMsZ0JBQWdCekQsR0FBR3lELGFBQXZCO0FBQ0EsT0FBSUMsUUFBUTFELEdBQUcwRCxLQUFmOztBQUVBLE9BQUlDLGFBQWEsQ0FBQzNELEdBQUc0QixhQUFILENBQWlCRCxLQUFqQixDQUFsQjtBQUNBLE9BQUlpQyxLQUFKO0FBQ0EsT0FBSUMsY0FBSjtBQUNBLE9BQUlDLFFBQVE5RCxHQUFHK0QsR0FBSCxHQUFTTCxLQUFyQjs7QUFFQSxPQUFJMUQsR0FBR00sWUFBSCxFQUFKLEVBQXVCO0FBQ3RCdUQscUJBQWlCN0QsR0FBRzRDLEtBQUgsSUFBWVksY0FBY3hELEdBQUdnRSxZQUE3QixDQUFqQjtBQUNBSixZQUFRNUQsR0FBR2lFLElBQUgsR0FBV0osaUJBQWlCQyxLQUFqQixJQUEwQkgsYUFBYUQsS0FBdkMsQ0FBbkI7QUFDQSxXQUFPckIsS0FBSzZCLEtBQUwsQ0FBV04sUUFBUUosV0FBbkIsQ0FBUDtBQUNBO0FBQ0RLLG9CQUFpQjdELEdBQUdtRCxNQUFILElBQWFuRCxHQUFHbUUsVUFBSCxHQUFnQlYsYUFBN0IsQ0FBakI7QUFDQUcsV0FBUzVELEdBQUdvRSxNQUFILEdBQVlYLGFBQWIsR0FBK0JJLGlCQUFpQkMsS0FBakIsSUFBMEJILGFBQWFELEtBQXZDLENBQXZDO0FBQ0EsVUFBT3JCLEtBQUs2QixLQUFMLENBQVdOLEtBQVgsQ0FBUDtBQUNBLEdBMUk2QztBQTJJOUNTLG9CQUFrQiwwQkFBU1QsS0FBVCxFQUFnQjtBQUNqQyxPQUFJNUQsS0FBSyxJQUFUO0FBQ0EsT0FBSU0sZUFBZU4sR0FBR00sWUFBSCxFQUFuQjtBQUNBLE9BQUlrRCxjQUFjeEQsR0FBR3dELFdBQXJCO0FBQ0EsT0FBSUMsZ0JBQWdCekQsR0FBR3lELGFBQXZCO0FBQ0EsT0FBSUksaUJBQWlCdkQsZUFBZU4sR0FBRzRDLEtBQUgsSUFBWVksY0FBY3hELEdBQUdnRSxZQUE3QixDQUFmLEdBQTREaEUsR0FBR21ELE1BQUgsSUFBYW5ELEdBQUdtRSxVQUFILEdBQWdCVixhQUE3QixDQUFqRjtBQUNBLE9BQUlhLFNBQVMsQ0FBQ2hFLGVBQWVzRCxRQUFRNUQsR0FBR2lFLElBQVgsR0FBa0JULFdBQWpDLEdBQStDeEQsR0FBR29FLE1BQUgsR0FBWVgsYUFBWixHQUE0QkcsS0FBNUUsSUFBcUZDLGNBQWxHO0FBQ0EsVUFBTzdELEdBQUcwRCxLQUFILEdBQVksQ0FBQzFELEdBQUcrRCxHQUFILEdBQVMvRCxHQUFHMEQsS0FBYixJQUFzQlksTUFBekM7QUFDQSxHQW5KNkM7QUFvSjlDQyxtQkFBaUIseUJBQVM3QyxLQUFULEVBQWdCO0FBQ2hDLFVBQU8sS0FBSzZCLGdCQUFMLENBQXNCLEtBQUtpQixjQUFMLENBQW9COUMsS0FBcEIsQ0FBdEIsQ0FBUDtBQUNBO0FBdEo2QyxFQUE3QixDQUFsQjtBQXdKQXZDLE9BQU1zRixZQUFOLENBQW1CQyxpQkFBbkIsQ0FBcUMsUUFBckMsRUFBK0M5RSxXQUEvQyxFQUE0RFAsYUFBNUQ7QUFFQSxDQXJLRCIsImZpbGUiOiJzY2FsZS5saW5lYXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKENoYXJ0KSB7XHJcblxyXG5cdHZhciBoZWxwZXJzID0gQ2hhcnQuaGVscGVycztcclxuXHJcblx0dmFyIGRlZmF1bHRDb25maWcgPSB7XHJcblx0XHRwb3NpdGlvbjogJ2xlZnQnLFxyXG5cdFx0dGlja3M6IHtcclxuXHRcdFx0Y2FsbGJhY2s6IENoYXJ0LlRpY2tzLmZvcm1hdHRlcnMubGluZWFyXHJcblx0XHR9XHJcblx0fTtcclxuXHJcblx0dmFyIExpbmVhclNjYWxlID0gQ2hhcnQuTGluZWFyU2NhbGVCYXNlLmV4dGVuZCh7XHJcblx0XHRkZXRlcm1pbmVEYXRhTGltaXRzOiBmdW5jdGlvbigpIHtcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIG9wdHMgPSBtZS5vcHRpb25zO1xyXG5cdFx0XHR2YXIgY2hhcnQgPSBtZS5jaGFydDtcclxuXHRcdFx0dmFyIGRhdGEgPSBjaGFydC5kYXRhO1xyXG5cdFx0XHR2YXIgZGF0YXNldHMgPSBkYXRhLmRhdGFzZXRzO1xyXG5cdFx0XHR2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7XHJcblxyXG5cdFx0XHRmdW5jdGlvbiBJRE1hdGNoZXMobWV0YSkge1xyXG5cdFx0XHRcdHJldHVybiBpc0hvcml6b250YWwgPyBtZXRhLnhBeGlzSUQgPT09IG1lLmlkIDogbWV0YS55QXhpc0lEID09PSBtZS5pZDtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0Ly8gRmlyc3QgQ2FsY3VsYXRlIHRoZSByYW5nZVxyXG5cdFx0XHRtZS5taW4gPSBudWxsO1xyXG5cdFx0XHRtZS5tYXggPSBudWxsO1xyXG5cclxuXHRcdFx0aWYgKG9wdHMuc3RhY2tlZCkge1xyXG5cdFx0XHRcdHZhciB2YWx1ZXNQZXJUeXBlID0ge307XHJcblxyXG5cdFx0XHRcdGhlbHBlcnMuZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7XHJcblx0XHRcdFx0XHR2YXIgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7XHJcblx0XHRcdFx0XHRpZiAodmFsdWVzUGVyVHlwZVttZXRhLnR5cGVdID09PSB1bmRlZmluZWQpIHtcclxuXHRcdFx0XHRcdFx0dmFsdWVzUGVyVHlwZVttZXRhLnR5cGVdID0ge1xyXG5cdFx0XHRcdFx0XHRcdHBvc2l0aXZlVmFsdWVzOiBbXSxcclxuXHRcdFx0XHRcdFx0XHRuZWdhdGl2ZVZhbHVlczogW11cclxuXHRcdFx0XHRcdFx0fTtcclxuXHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHQvLyBTdG9yZSB0aGVzZSBwZXIgdHlwZVxyXG5cdFx0XHRcdFx0dmFyIHBvc2l0aXZlVmFsdWVzID0gdmFsdWVzUGVyVHlwZVttZXRhLnR5cGVdLnBvc2l0aXZlVmFsdWVzO1xyXG5cdFx0XHRcdFx0dmFyIG5lZ2F0aXZlVmFsdWVzID0gdmFsdWVzUGVyVHlwZVttZXRhLnR5cGVdLm5lZ2F0aXZlVmFsdWVzO1xyXG5cclxuXHRcdFx0XHRcdGlmIChjaGFydC5pc0RhdGFzZXRWaXNpYmxlKGRhdGFzZXRJbmRleCkgJiYgSURNYXRjaGVzKG1ldGEpKSB7XHJcblx0XHRcdFx0XHRcdGhlbHBlcnMuZWFjaChkYXRhc2V0LmRhdGEsIGZ1bmN0aW9uKHJhd1ZhbHVlLCBpbmRleCkge1xyXG5cdFx0XHRcdFx0XHRcdHZhciB2YWx1ZSA9ICttZS5nZXRSaWdodFZhbHVlKHJhd1ZhbHVlKTtcclxuXHRcdFx0XHRcdFx0XHRpZiAoaXNOYU4odmFsdWUpIHx8IG1ldGEuZGF0YVtpbmRleF0uaGlkZGVuKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdFx0XHRwb3NpdGl2ZVZhbHVlc1tpbmRleF0gPSBwb3NpdGl2ZVZhbHVlc1tpbmRleF0gfHwgMDtcclxuXHRcdFx0XHRcdFx0XHRuZWdhdGl2ZVZhbHVlc1tpbmRleF0gPSBuZWdhdGl2ZVZhbHVlc1tpbmRleF0gfHwgMDtcclxuXHJcblx0XHRcdFx0XHRcdFx0aWYgKG9wdHMucmVsYXRpdmVQb2ludHMpIHtcclxuXHRcdFx0XHRcdFx0XHRcdHBvc2l0aXZlVmFsdWVzW2luZGV4XSA9IDEwMDtcclxuXHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKHZhbHVlIDwgMCkge1xyXG5cdFx0XHRcdFx0XHRcdFx0bmVnYXRpdmVWYWx1ZXNbaW5kZXhdICs9IHZhbHVlO1xyXG5cdFx0XHRcdFx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0XHRcdFx0XHRwb3NpdGl2ZVZhbHVlc1tpbmRleF0gKz0gdmFsdWU7XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cdFx0XHRcdFx0XHR9KTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9KTtcclxuXHJcblx0XHRcdFx0aGVscGVycy5lYWNoKHZhbHVlc1BlclR5cGUsIGZ1bmN0aW9uKHZhbHVlc0ZvclR5cGUpIHtcclxuXHRcdFx0XHRcdHZhciB2YWx1ZXMgPSB2YWx1ZXNGb3JUeXBlLnBvc2l0aXZlVmFsdWVzLmNvbmNhdCh2YWx1ZXNGb3JUeXBlLm5lZ2F0aXZlVmFsdWVzKTtcclxuXHRcdFx0XHRcdHZhciBtaW5WYWwgPSBoZWxwZXJzLm1pbih2YWx1ZXMpO1xyXG5cdFx0XHRcdFx0dmFyIG1heFZhbCA9IGhlbHBlcnMubWF4KHZhbHVlcyk7XHJcblx0XHRcdFx0XHRtZS5taW4gPSBtZS5taW4gPT09IG51bGwgPyBtaW5WYWwgOiBNYXRoLm1pbihtZS5taW4sIG1pblZhbCk7XHJcblx0XHRcdFx0XHRtZS5tYXggPSBtZS5tYXggPT09IG51bGwgPyBtYXhWYWwgOiBNYXRoLm1heChtZS5tYXgsIG1heFZhbCk7XHJcblx0XHRcdFx0fSk7XHJcblxyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdGhlbHBlcnMuZWFjaChkYXRhc2V0cywgZnVuY3Rpb24oZGF0YXNldCwgZGF0YXNldEluZGV4KSB7XHJcblx0XHRcdFx0XHR2YXIgbWV0YSA9IGNoYXJ0LmdldERhdGFzZXRNZXRhKGRhdGFzZXRJbmRleCk7XHJcblx0XHRcdFx0XHRpZiAoY2hhcnQuaXNEYXRhc2V0VmlzaWJsZShkYXRhc2V0SW5kZXgpICYmIElETWF0Y2hlcyhtZXRhKSkge1xyXG5cdFx0XHRcdFx0XHRoZWxwZXJzLmVhY2goZGF0YXNldC5kYXRhLCBmdW5jdGlvbihyYXdWYWx1ZSwgaW5kZXgpIHtcclxuXHRcdFx0XHRcdFx0XHR2YXIgdmFsdWUgPSArbWUuZ2V0UmlnaHRWYWx1ZShyYXdWYWx1ZSk7XHJcblx0XHRcdFx0XHRcdFx0aWYgKGlzTmFOKHZhbHVlKSB8fCBtZXRhLmRhdGFbaW5kZXhdLmhpZGRlbikge1xyXG5cdFx0XHRcdFx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHRcdFx0XHRcdH1cclxuXHJcblx0XHRcdFx0XHRcdFx0aWYgKG1lLm1pbiA9PT0gbnVsbCkge1xyXG5cdFx0XHRcdFx0XHRcdFx0bWUubWluID0gdmFsdWU7XHJcblx0XHRcdFx0XHRcdFx0fSBlbHNlIGlmICh2YWx1ZSA8IG1lLm1pbikge1xyXG5cdFx0XHRcdFx0XHRcdFx0bWUubWluID0gdmFsdWU7XHJcblx0XHRcdFx0XHRcdFx0fVxyXG5cclxuXHRcdFx0XHRcdFx0XHRpZiAobWUubWF4ID09PSBudWxsKSB7XHJcblx0XHRcdFx0XHRcdFx0XHRtZS5tYXggPSB2YWx1ZTtcclxuXHRcdFx0XHRcdFx0XHR9IGVsc2UgaWYgKHZhbHVlID4gbWUubWF4KSB7XHJcblx0XHRcdFx0XHRcdFx0XHRtZS5tYXggPSB2YWx1ZTtcclxuXHRcdFx0XHRcdFx0XHR9XHJcblx0XHRcdFx0XHRcdH0pO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH0pO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHQvLyBDb21tb24gYmFzZSBpbXBsZW1lbnRhdGlvbiB0byBoYW5kbGUgdGlja3MubWluLCB0aWNrcy5tYXgsIHRpY2tzLmJlZ2luQXRaZXJvXHJcblx0XHRcdHRoaXMuaGFuZGxlVGlja1JhbmdlT3B0aW9ucygpO1xyXG5cdFx0fSxcclxuXHRcdGdldFRpY2tMaW1pdDogZnVuY3Rpb24oKSB7XHJcblx0XHRcdHZhciBtYXhUaWNrcztcclxuXHRcdFx0dmFyIG1lID0gdGhpcztcclxuXHRcdFx0dmFyIHRpY2tPcHRzID0gbWUub3B0aW9ucy50aWNrcztcclxuXHJcblx0XHRcdGlmIChtZS5pc0hvcml6b250YWwoKSkge1xyXG5cdFx0XHRcdG1heFRpY2tzID0gTWF0aC5taW4odGlja09wdHMubWF4VGlja3NMaW1pdCA/IHRpY2tPcHRzLm1heFRpY2tzTGltaXQgOiAxMSwgTWF0aC5jZWlsKG1lLndpZHRoIC8gNTApKTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHQvLyBUaGUgZmFjdG9yIG9mIDIgdXNlZCB0byBzY2FsZSB0aGUgZm9udCBzaXplIGhhcyBiZWVuIGV4cGVyaW1lbnRhbGx5IGRldGVybWluZWQuXHJcblx0XHRcdFx0dmFyIHRpY2tGb250U2l6ZSA9IGhlbHBlcnMuZ2V0VmFsdWVPckRlZmF1bHQodGlja09wdHMuZm9udFNpemUsIENoYXJ0LmRlZmF1bHRzLmdsb2JhbC5kZWZhdWx0Rm9udFNpemUpO1xyXG5cdFx0XHRcdG1heFRpY2tzID0gTWF0aC5taW4odGlja09wdHMubWF4VGlja3NMaW1pdCA/IHRpY2tPcHRzLm1heFRpY2tzTGltaXQgOiAxMSwgTWF0aC5jZWlsKG1lLmhlaWdodCAvICgyICogdGlja0ZvbnRTaXplKSkpO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRyZXR1cm4gbWF4VGlja3M7XHJcblx0XHR9LFxyXG5cdFx0Ly8gQ2FsbGVkIGFmdGVyIHRoZSB0aWNrcyBhcmUgYnVpbHQuIFdlIG5lZWRcclxuXHRcdGhhbmRsZURpcmVjdGlvbmFsQ2hhbmdlczogZnVuY3Rpb24oKSB7XHJcblx0XHRcdGlmICghdGhpcy5pc0hvcml6b250YWwoKSkge1xyXG5cdFx0XHRcdC8vIFdlIGFyZSBpbiBhIHZlcnRpY2FsIG9yaWVudGF0aW9uLiBUaGUgdG9wIHZhbHVlIGlzIHRoZSBoaWdoZXN0LiBTbyByZXZlcnNlIHRoZSBhcnJheVxyXG5cdFx0XHRcdHRoaXMudGlja3MucmV2ZXJzZSgpO1xyXG5cdFx0XHR9XHJcblx0XHR9LFxyXG5cdFx0Z2V0TGFiZWxGb3JJbmRleDogZnVuY3Rpb24oaW5kZXgsIGRhdGFzZXRJbmRleCkge1xyXG5cdFx0XHRyZXR1cm4gK3RoaXMuZ2V0UmlnaHRWYWx1ZSh0aGlzLmNoYXJ0LmRhdGEuZGF0YXNldHNbZGF0YXNldEluZGV4XS5kYXRhW2luZGV4XSk7XHJcblx0XHR9LFxyXG5cdFx0Ly8gVXRpbHNcclxuXHRcdGdldFBpeGVsRm9yVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKSB7XHJcblx0XHRcdC8vIFRoaXMgbXVzdCBiZSBjYWxsZWQgYWZ0ZXIgZml0IGhhcyBiZWVuIHJ1biBzbyB0aGF0XHJcblx0XHRcdC8vIHRoaXMubGVmdCwgdGhpcy50b3AsIHRoaXMucmlnaHQsIGFuZCB0aGlzLmJvdHRvbSBoYXZlIGJlZW4gZGVmaW5lZFxyXG5cdFx0XHR2YXIgbWUgPSB0aGlzO1xyXG5cdFx0XHR2YXIgcGFkZGluZ0xlZnQgPSBtZS5wYWRkaW5nTGVmdDtcclxuXHRcdFx0dmFyIHBhZGRpbmdCb3R0b20gPSBtZS5wYWRkaW5nQm90dG9tO1xyXG5cdFx0XHR2YXIgc3RhcnQgPSBtZS5zdGFydDtcclxuXHJcblx0XHRcdHZhciByaWdodFZhbHVlID0gK21lLmdldFJpZ2h0VmFsdWUodmFsdWUpO1xyXG5cdFx0XHR2YXIgcGl4ZWw7XHJcblx0XHRcdHZhciBpbm5lckRpbWVuc2lvbjtcclxuXHRcdFx0dmFyIHJhbmdlID0gbWUuZW5kIC0gc3RhcnQ7XHJcblxyXG5cdFx0XHRpZiAobWUuaXNIb3Jpem9udGFsKCkpIHtcclxuXHRcdFx0XHRpbm5lckRpbWVuc2lvbiA9IG1lLndpZHRoIC0gKHBhZGRpbmdMZWZ0ICsgbWUucGFkZGluZ1JpZ2h0KTtcclxuXHRcdFx0XHRwaXhlbCA9IG1lLmxlZnQgKyAoaW5uZXJEaW1lbnNpb24gLyByYW5nZSAqIChyaWdodFZhbHVlIC0gc3RhcnQpKTtcclxuXHRcdFx0XHRyZXR1cm4gTWF0aC5yb3VuZChwaXhlbCArIHBhZGRpbmdMZWZ0KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRpbm5lckRpbWVuc2lvbiA9IG1lLmhlaWdodCAtIChtZS5wYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSk7XHJcblx0XHRcdHBpeGVsID0gKG1lLmJvdHRvbSAtIHBhZGRpbmdCb3R0b20pIC0gKGlubmVyRGltZW5zaW9uIC8gcmFuZ2UgKiAocmlnaHRWYWx1ZSAtIHN0YXJ0KSk7XHJcblx0XHRcdHJldHVybiBNYXRoLnJvdW5kKHBpeGVsKTtcclxuXHRcdH0sXHJcblx0XHRnZXRWYWx1ZUZvclBpeGVsOiBmdW5jdGlvbihwaXhlbCkge1xyXG5cdFx0XHR2YXIgbWUgPSB0aGlzO1xyXG5cdFx0XHR2YXIgaXNIb3Jpem9udGFsID0gbWUuaXNIb3Jpem9udGFsKCk7XHJcblx0XHRcdHZhciBwYWRkaW5nTGVmdCA9IG1lLnBhZGRpbmdMZWZ0O1xyXG5cdFx0XHR2YXIgcGFkZGluZ0JvdHRvbSA9IG1lLnBhZGRpbmdCb3R0b207XHJcblx0XHRcdHZhciBpbm5lckRpbWVuc2lvbiA9IGlzSG9yaXpvbnRhbCA/IG1lLndpZHRoIC0gKHBhZGRpbmdMZWZ0ICsgbWUucGFkZGluZ1JpZ2h0KSA6IG1lLmhlaWdodCAtIChtZS5wYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbSk7XHJcblx0XHRcdHZhciBvZmZzZXQgPSAoaXNIb3Jpem9udGFsID8gcGl4ZWwgLSBtZS5sZWZ0IC0gcGFkZGluZ0xlZnQgOiBtZS5ib3R0b20gLSBwYWRkaW5nQm90dG9tIC0gcGl4ZWwpIC8gaW5uZXJEaW1lbnNpb247XHJcblx0XHRcdHJldHVybiBtZS5zdGFydCArICgobWUuZW5kIC0gbWUuc3RhcnQpICogb2Zmc2V0KTtcclxuXHRcdH0sXHJcblx0XHRnZXRQaXhlbEZvclRpY2s6IGZ1bmN0aW9uKGluZGV4KSB7XHJcblx0XHRcdHJldHVybiB0aGlzLmdldFBpeGVsRm9yVmFsdWUodGhpcy50aWNrc0FzTnVtYmVyc1tpbmRleF0pO1xyXG5cdFx0fVxyXG5cdH0pO1xyXG5cdENoYXJ0LnNjYWxlU2VydmljZS5yZWdpc3RlclNjYWxlVHlwZSgnbGluZWFyJywgTGluZWFyU2NhbGUsIGRlZmF1bHRDb25maWcpO1xyXG5cclxufTtcclxuIl19